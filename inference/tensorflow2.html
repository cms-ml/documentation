<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation of the CMS Machine Learning Group"><link rel=canonical href=https://cms-ml.github.io/documentation/inference/tensorflow2.html><meta name=author content="CMS Machine Learning Group"><link rel="shortcut icon" href=../images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-5.5.3"><title>TensorFlow 2 - CMS Machine Learning Documentation</title><link rel=stylesheet href=../assets/stylesheets/main.947af8d5.min.css><link rel=stylesheet href=../assets/stylesheets/palette.7f672a1f.min.css><meta name=theme-color content=#3f51b5><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=indigo data-md-color-accent=orange> <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#direct-inference-with-tensorflow-2 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://cms-ml.github.io/documentation title="CMS Machine Learning Documentation" class="md-header-nav__button md-logo" aria-label="CMS Machine Learning Documentation"> <img src=../images/logo.png alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> CMS Machine Learning Documentation </span> <span class="md-header-nav__topic md-ellipsis"> TensorFlow 2 </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/cms-ml/documentation/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> cms-ml/documentation </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://cms-ml.github.io/documentation title="CMS Machine Learning Documentation" class="md-nav__button md-logo" aria-label="CMS Machine Learning Documentation"> <img src=../images/logo.png alt=logo> </a> CMS Machine Learning Documentation </label> <div class=md-nav__source> <a href=https://github.com/cms-ml/documentation/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> cms-ml/documentation </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Tutorials <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Tutorials data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> Optimization <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Optimization data-md-level=2> <label class=md-nav__title for=nav-2-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Optimization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../optimization/introduction.html title="Model optimization" class=md-nav__link> Model optimization </a> </li> <li class=md-nav__item> <a href=../optimization/importance.html title="Feature importance" class=md-nav__link> Feature importance </a> </li> <li class=md-nav__item> <a href=../optimization/data_augmentation.html title="Data augmentation" class=md-nav__link> Data augmentation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Validation <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Validation data-md-level=2> <label class=md-nav__title for=nav-2-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Validation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../validation/overtraining.html title=Overtraining class=md-nav__link> Overtraining </a> </li> <li class=md-nav__item> <a href=../validation/cross_validation.html title="Cross validation" class=md-nav__link> Cross validation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3 checked> <label class=md-nav__link for=nav-2-3> Inference <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Inference data-md-level=2> <label class=md-nav__title for=nav-2-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Inference </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-3-1 type=checkbox id=nav-2-3-1 checked> <label class=md-nav__link for=nav-2-3-1> Direct inference <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Direct inference" data-md-level=3> <label class=md-nav__title for=nav-2-3-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Direct inference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=tensorflow1.html title="TensorFlow 1" class=md-nav__link> TensorFlow 1 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> TensorFlow 2 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg> </span> </label> <a href=tensorflow2.html title="TensorFlow 2" class="md-nav__link md-nav__link--active"> TensorFlow 2 </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#software-setup class=md-nav__link> Software setup </a> </li> <li class=md-nav__item> <a href=#saving-your-model class=md-nav__link> Saving your model </a> </li> <li class=md-nav__item> <a href=#inference-in-cmssw class=md-nav__link> Inference in CMSSW </a> <nav class=md-nav aria-label="Inference in CMSSW"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cmssw-module-setup class=md-nav__link> CMSSW module setup </a> </li> <li class=md-nav__item> <a href=#single-threaded-inference class=md-nav__link> Single-threaded inference </a> <nav class=md-nav aria-label="Single-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes class=md-nav__link> 1. Includes </a> </li> <li class=md-nav__item> <a href=#2-initialize-objects class=md-nav__link> 2. Initialize objects </a> </li> <li class=md-nav__item> <a href=#3-inference class=md-nav__link> 3. Inference </a> </li> <li class=md-nav__item> <a href=#4-cleanup class=md-nav__link> 4. Cleanup </a> </li> <li class=md-nav__item> <a href=#full-example class=md-nav__link> Full example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#multi-threaded-inference class=md-nav__link> Multi-threaded inference </a> <nav class=md-nav aria-label="Multi-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes_1 class=md-nav__link> 1. Includes </a> </li> <li class=md-nav__item> <a href=#2-define-and-use-the-cache class=md-nav__link> 2. Define and use the cache </a> </li> <li class=md-nav__item> <a href=#3-initialize-objects class=md-nav__link> 3. Initialize objects </a> </li> <li class=md-nav__item> <a href=#4-inference class=md-nav__link> 4. Inference </a> </li> <li class=md-nav__item> <a href=#5-cleanup class=md-nav__link> 5. Cleanup </a> </li> <li class=md-nav__item> <a href=#full-example_1 class=md-nav__link> Full example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#optimization class=md-nav__link> Optimization </a> <nav class=md-nav aria-label=Optimization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reusing-tensors class=md-nav__link> Reusing tensors </a> </li> <li class=md-nav__item> <a href=#tensor-data-access-via-pointers class=md-nav__link> Tensor data access via pointers </a> </li> <li class=md-nav__item> <a href=#inter-and-intra-operation-parallelism class=md-nav__link> Inter- and intra-operation parallelism </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#miscellaneous class=md-nav__link> Miscellaneous </a> <nav class=md-nav aria-label=Miscellaneous> <ul class=md-nav__list> <li class=md-nav__item> <a href=#logging class=md-nav__link> Logging </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#links-and-further-reading class=md-nav__link> Links and further reading </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=onnx.html title=ONNX class=md-nav__link> ONNX </a> </li> <li class=md-nav__item> <a href=xgboost.html title=XGBoost class=md-nav__link> XGBoost </a> </li> <li class=md-nav__item> <a href=hls4ml.html title=hls4ml class=md-nav__link> hls4ml </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-3-2 type=checkbox id=nav-2-3-2> <label class=md-nav__link for=nav-2-3-2> Inference as a service <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Inference as a service" data-md-level=3> <label class=md-nav__title for=nav-2-3-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Inference as a service </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=sonic_triton.html title=Sonic/Triton class=md-nav__link> Sonic/Triton </a> </li> <li class=md-nav__item> <a href=tfaas.html title=TFaaS class=md-nav__link> TFaaS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-3-3 type=checkbox id=nav-2-3-3> <label class=md-nav__link for=nav-2-3-3> Non-standard workflows <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Non-standard workflows" data-md-level=3> <label class=md-nav__title for=nav-2-3-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Non-standard workflows </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=standalone.html title="Standalone framework" class=md-nav__link> Standalone framework </a> </li> <li class=md-nav__item> <a href=swan_aws.html title="SWAN + AWS" class=md-nav__link> SWAN + AWS </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=checklist.html title="Integration checklist" class=md-nav__link> Integration checklist </a> </li> <li class=md-nav__item> <a href=performance.html title=Performance class=md-nav__link> Performance </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2-3-6 type=checkbox id=nav-2-3-6> <label class=md-nav__link for=nav-2-3-6> Successful integrations <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Successful integrations" data-md-level=3> <label class=md-nav__title for=nav-2-3-6> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Successful integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=particlenet.html title=ParticleNet class=md-nav__link> ParticleNet </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Resources <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Resources data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Resources/Cloud_Resources/index.html title="Cloud Resources" class=md-nav__link> Cloud Resources </a> </li> <li class=md-nav__item> <a href=../Resources/FPGA_Resources/index.html title="FPGA Resource" class=md-nav__link> FPGA Resource </a> </li> <li class=md-nav__item> <a href=../Resources/GPU_Resources/index.html title="GPU Resources" class=md-nav__link> GPU Resources </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#software-setup class=md-nav__link> Software setup </a> </li> <li class=md-nav__item> <a href=#saving-your-model class=md-nav__link> Saving your model </a> </li> <li class=md-nav__item> <a href=#inference-in-cmssw class=md-nav__link> Inference in CMSSW </a> <nav class=md-nav aria-label="Inference in CMSSW"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cmssw-module-setup class=md-nav__link> CMSSW module setup </a> </li> <li class=md-nav__item> <a href=#single-threaded-inference class=md-nav__link> Single-threaded inference </a> <nav class=md-nav aria-label="Single-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes class=md-nav__link> 1. Includes </a> </li> <li class=md-nav__item> <a href=#2-initialize-objects class=md-nav__link> 2. Initialize objects </a> </li> <li class=md-nav__item> <a href=#3-inference class=md-nav__link> 3. Inference </a> </li> <li class=md-nav__item> <a href=#4-cleanup class=md-nav__link> 4. Cleanup </a> </li> <li class=md-nav__item> <a href=#full-example class=md-nav__link> Full example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#multi-threaded-inference class=md-nav__link> Multi-threaded inference </a> <nav class=md-nav aria-label="Multi-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes_1 class=md-nav__link> 1. Includes </a> </li> <li class=md-nav__item> <a href=#2-define-and-use-the-cache class=md-nav__link> 2. Define and use the cache </a> </li> <li class=md-nav__item> <a href=#3-initialize-objects class=md-nav__link> 3. Initialize objects </a> </li> <li class=md-nav__item> <a href=#4-inference class=md-nav__link> 4. Inference </a> </li> <li class=md-nav__item> <a href=#5-cleanup class=md-nav__link> 5. Cleanup </a> </li> <li class=md-nav__item> <a href=#full-example_1 class=md-nav__link> Full example </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#optimization class=md-nav__link> Optimization </a> <nav class=md-nav aria-label=Optimization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reusing-tensors class=md-nav__link> Reusing tensors </a> </li> <li class=md-nav__item> <a href=#tensor-data-access-via-pointers class=md-nav__link> Tensor data access via pointers </a> </li> <li class=md-nav__item> <a href=#inter-and-intra-operation-parallelism class=md-nav__link> Inter- and intra-operation parallelism </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#miscellaneous class=md-nav__link> Miscellaneous </a> <nav class=md-nav aria-label=Miscellaneous> <ul class=md-nav__list> <li class=md-nav__item> <a href=#logging class=md-nav__link> Logging </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#links-and-further-reading class=md-nav__link> Links and further reading </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/cms-ml/documentation/blob/master/content/inference/tensorflow2.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=direct-inference-with-tensorflow-2>Direct inference with TensorFlow 2<a class=headerlink href=#direct-inference-with-tensorflow-2 title="Permanent link">&para;</a></h1> <hr> <p>TensorFlow 2 is available since CMSSW_11_1_X (<a href=https://github.com/cms-sw/cmssw/pull/28711>cmssw#28711</a>, <a href=https://github.com/cms-sw/cmsdist/pull/5525>cmsdist#5525</a>). The integration into the software stack can be found in <a href=https://github.com/cms-sw/cmsdist/blob/latest/tensorflow.spec>cmsdist/tensorflow.spec</a> and the interface is located in <a href=https://github.com/cms-sw/cmssw/tree/master/PhysicsTools/TensorFlow>cmssw/PhysicsTools/TensorFlow</a>.</p> <p>The current version is 2.1.0 and, at the moment, only supports inference on CPU. GPU support is planned for the integration of version 2.3.</p> <p>See the guide on <a href=tensorflow1.html>inference with TensorFlow 1</a> for earlier versions.</p> <h2 id=software-setup>Software setup<a class=headerlink href=#software-setup title="Permanent link">&para;</a></h2> <p>To run the examples shown below, create a mininmal inference setup with the following snippet.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>SCRAM_ARCH</span><span class=o>=</span><span class=s2>&quot;slc7_amd64_gcc820&quot;</span>
<span class=nb>export</span> <span class=nv>CMSSW_VERSION</span><span class=o>=</span><span class=s2>&quot;CMSSW_11_1_2&quot;</span>

<span class=nb>source</span> /cvmfs/cms.cern.ch/cmsset_default.sh

cmsrel <span class=s2>&quot;</span><span class=nv>$CMSSW_VERSION</span><span class=s2>&quot;</span>
<span class=nb>cd</span> <span class=s2>&quot;</span><span class=nv>$CMSSW_VERSION</span><span class=s2>/src&quot;</span>

cmsenv
scram b
</code></pre></div> </td></tr></table> <p>Below, the <a href=https://github.com/cms-ml/cmsml><code>cmsml</code></a> Python package is used to convert models from TensorFlow objects (<code>tf.function</code>'s or Keras models) to protobuf graph files (<a href=https://cmsml.readthedocs.io>documentation</a>). It should be available after executing the commands above. You can check its version via</p> <div class=highlight><pre><span></span><code>python -c <span class=s2>&quot;import cmsml; print(cmsml.__version__)&quot;</span>
</code></pre></div> <p>and compare to the <a href=https://github.com/cms-ml/cmsml/tags>released tags</a>. If you want to install a newer version from either the <a href=https://github.com/cms-ml/cmsml>master branch of the cmsml repository</a> or the <a href=https://pypi.org/project/cmsml>Python package index (PyPI)</a>, you can simply do that via pip.</p> <div class=tabbed-set data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1>master</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1># into your user directory (usually ~/.local)</span>
pip install --upgrade --user git+https://github.com/cms-ml/cmsml

<span class=c1># _or_</span>

<span class=c1># into a custom directory</span>
pip install --upgrade --prefix <span class=s2>&quot;CUSTOM_DIRECTORY&quot;</span> git+https://github.com/cms-ml/cmsml
</code></pre></div> </div> <input id=__tabbed_1_2 name=__tabbed_1 type=radio><label for=__tabbed_1_2>PyPI</label><div class=tabbed-content> <div class=highlight><pre><span></span><code><span class=c1># into your user directory (usually ~/.local)</span>
pip install --upgrade --user cmsml

<span class=c1># _or_</span>

<span class=c1># into a custom directory</span>
pip install --upgrade --prefix <span class=s2>&quot;CUSTOM_DIRECTORY&quot;</span> cmsml
</code></pre></div> </div> </div> <h2 id=saving-your-model>Saving your model<a class=headerlink href=#saving-your-model title="Permanent link">&para;</a></h2> <p>After successfully training, you should save your model in a protobuf graph file which can be read by the interface in CMSSW. Naturally, you only want to save that part of your model is required to run the network prediction, i.e., it should <mark>not</mark> contain operations related to model training or loss functions (unless explicitely required). Also, to reduce the memory footprint and to accelerate the inference, variables should be converted to constant tensors. Both of these model transformations are provided by the <code>cmsml</code> package.</p> <p>Instructions on how to transform and save your model are shown below, depending on whether you use Keras or plain TensorFlow with <code>tf.function</code>'s.</p> <div class=tabbed-set data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><label for=__tabbed_2_1>Keras</label><div class=tabbed-content> <p>The code below saves a Keras <code>Model</code> instance as a protobuf graph file using <a href=https://cmsml.readthedocs.io/en/latest/api/tensorflow.html#cmsml.tensorflow.save_graph><code>cmsml.tensorflow.save_graph</code></a>. In order for Keras to built the internal graph representation before saving, make sure to either compile the model, or pass an <code>input_shape</code> to the first layer:</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<span class=kn>import</span> <span class=nn>tf.keras.layers</span> <span class=k>as</span> <span class=nn>layers</span>
<span class=kn>import</span> <span class=nn>cmsml</span>

<span class=c1># define your model</span>
<span class=n>model</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Sequential</span><span class=p>()</span>
<span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>layers</span><span class=o>.</span><span class=n>InputLayer</span><span class=p>(</span><span class=n>input_shape</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;input&quot;</span><span class=p>))</span>
<span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;tanh&quot;</span><span class=p>))</span>
<span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;softmax&quot;</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;output&quot;</span><span class=p>))</span>

<span class=c1># train it</span>
<span class=o>...</span>

<span class=c1># convert to binary (.pb extension) protobuf</span>
<span class=c1># with variables converted to constants</span>
<span class=hll><span class=n>cmsml</span><span class=o>.</span><span class=n>tensorflow</span><span class=o>.</span><span class=n>save_graph</span><span class=p>(</span><span class=s2>&quot;graph.pb&quot;</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>variables_to_constants</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> </td></tr></table> <p>Following the Keras naming conventions for certain layers, the input will be named <code>"input"</code> while the output is named <code>"sequential/output/Softmax"</code>. To cross check the names, you can save the graph in text format by using the extension <code>".pb.txt"</code>.</p> </div> <input id=__tabbed_2_2 name=__tabbed_2 type=radio><label for=__tabbed_2_2>tf.function</label><div class=tabbed-content> <p>Let's consider you write your network model in a single <code>tf.function</code>.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<span class=kn>import</span> <span class=nn>cmsml</span>

<span class=c1># define the model</span>
<span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
<span class=k>def</span> <span class=nf>model</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
    <span class=c1># lift variable initialization to the lowest context so they are</span>
    <span class=c1># not re-initialized on every call (eager calls or signature tracing)</span>
    <span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>init_scope</span><span class=p>():</span>
        <span class=n>W</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>ones</span><span class=p>([</span><span class=mi>10</span><span class=p>,</span> <span class=mi>1</span><span class=p>]))</span>
        <span class=n>b</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>ones</span><span class=p>([</span><span class=mi>1</span><span class=p>]))</span>

    <span class=c1># define your &quot;complex&quot; model here</span>
    <span class=n>h</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>W</span><span class=p>),</span> <span class=n>b</span><span class=p>)</span>
    <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>tanh</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;y&quot;</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>y</span>
</code></pre></div> </td></tr></table> <p>In TensorFlow terms, the <code>model</code> function is <mark>polymorphic</mark> - it accepts different types of the input tensor <code>x</code> (<code>tf.float32</code>, <code>tf.float64</code>, ...). For each type, TensorFlow will create a <mark>concrete</mark> function with an associated <code>tf.Graph</code> object. This mechanism is referred to as <mark>signature tracing</mark>. For deeper insights into <code>tf.function</code>, the concepts of signature tracing, polymorphic and concrete functions, see the guide on <a href=https://www.tensorflow.org/guide/function>Better performance with <code>tf.function</code></a>.</p> <p>To save the model as a protobuf graph file, you explicitely need to create a concrete function. However, this is fairly easy once you know the exact type and shape of all input arguments.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>20
21
22
23
24
25
26</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1># create a concrete function</span>
<span class=n>cmodel</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>get_concrete_function</span><span class=p>(</span>
    <span class=n>tf</span><span class=o>.</span><span class=n>TensorSpec</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>10</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>float32</span><span class=p>))</span>

<span class=c1># convert to binary (.pb extension) protobuf</span>
<span class=c1># with variables converted to constants</span>
<span class=hll><span class=n>cmsml</span><span class=o>.</span><span class=n>tensorflow</span><span class=o>.</span><span class=n>save_graph</span><span class=p>(</span><span class=s2>&quot;graph.pb&quot;</span><span class=p>,</span> <span class=n>cmodel</span><span class=p>,</span> <span class=n>variables_to_constants</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div> </td></tr></table> <p>The input will be named <code>"x"</code> while the output is named <code>"y"</code>. To cross check the names, you can save the graph in text format by using the extension <code>".pb.txt"</code>.</p> <details class=hint><summary>Different method: Frozen signatures</summary><p>Instead of creating a polymorphic <code>tf.function</code> and extracting a concrete one in a second step, you can directly define an input signature upon definition.</p> <div class=highlight><pre><span></span><code><span class=nd>@tf</span><span class=o>.</span><span class=n>function</span><span class=p>(</span><span class=n>input_signature</span><span class=o>=</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>TensorSpec</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>10</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>float32</span><span class=p>),))</span>
<span class=k>def</span> <span class=nf>model</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
    <span class=o>...</span>
</code></pre></div> <p>This disables signature tracing since the input signature is frozen. However, you can directly pass it to <a href=https://cmsml.readthedocs.io/en/latest/api/tensorflow.html#cmsml.tensorflow.save_graph><code>cmsml.tensorflow.save_graph</code></a>.</p> </details> </div> </div> <h2 id=inference-in-cmssw>Inference in CMSSW<a class=headerlink href=#inference-in-cmssw title="Permanent link">&para;</a></h2> <p>The inference can be implemented to run in a <a href=#single-threaded-inference>single thread</a>. In general, this does not mean that the module cannot be executed with multiple threads (<code class=highlight>cmsRun --numThreads &lt;N&gt; &lt;CFG_FILE&gt;</code>), but rather that its performance in terms of evaluation time and especially memory consumption is likely to be suboptimal. Therefore, for modules to be integrated into CMSSW, <mark>the <a href=#multi-threaded-inference>multi-threaded implementation</a> is strongly recommended</mark>.</p> <h3 id=cmssw-module-setup>CMSSW module setup<a class=headerlink href=#cmssw-module-setup title="Permanent link">&para;</a></h3> <p>If you aim to use the TensorFlow interface in a CMSSW <mark>plugin</mark>, make sure to include</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span> <span class=nt>/&gt;</span>

<span class=nt>&lt;flags</span> <span class=na>EDM_PLUGIN=</span><span class=s>&quot;1&quot;</span> <span class=nt>/&gt;</span>
</code></pre></div> </td></tr></table> <p>in your <code>plugins/BuildFile.xml</code> file. If you are using the interface inside the <code>src/</code> or <code>interface/</code> directory of your module, make sure to create a global <code>BuildFile.xml</code> file next to theses directories, containing (at least):</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span> <span class=nt>/&gt;</span>

<span class=nt>&lt;export&gt;</span>
    <span class=nt>&lt;lib</span> <span class=na>name=</span><span class=s>&quot;1&quot;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;/export&gt;</span>
</code></pre></div> </td></tr></table> <h3 id=single-threaded-inference>Single-threaded inference<a class=headerlink href=#single-threaded-inference title="Permanent link">&para;</a></h3> <p>Despite <code>tf.Session</code> being removed in the Python interface as of TensorFlow 2, the concepts of</p> <ul> <li><code>Graph</code>'s, containing the <em>constant</em> computational structure and trained variables of your model,</li> <li><code>Session</code>'s, handling execution, data exchange and device placement, and</li> <li>the separation between them</li> </ul> <p>lives on in the C++ interface. Thus, the overall inference approach is <strong>1)</strong> include the interface, <strong>2)</strong> initialize <code>Graph</code> and <code>session</code>, <strong>3)</strong> per event create input tensors and run the inference, and <strong>4)</strong> cleanup.</p> <h5 id=1-includes>1. Includes<a class=headerlink href=#1-includes title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=cp>#include</span> <span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/one/EDAnalyzer.h&quot;</span><span class=cp></span>
<span class=c1>// further framework includes</span>
<span class=p>...</span>
</code></pre></div> </td></tr></table> <h5 id=2-initialize-objects>2. Initialize objects<a class=headerlink href=#2-initialize-objects title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1>// configure logging to show warnings (see table below)</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=s>&quot;2&quot;</span><span class=p>);</span>

<span class=c1>// load the graph definition</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>GraphDef</span><span class=o>*</span> <span class=n>graphDef</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>loadGraphDef</span><span class=p>(</span><span class=s>&quot;/path/to/constantgraph.pb&quot;</span><span class=p>);</span>

<span class=c1>// create a session</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span> <span class=n>session</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef</span><span class=p>);</span>
</code></pre></div> </td></tr></table> <h5 id=3-inference>3. Inference<a class=headerlink href=#3-inference title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1>// create an input tensor</span>
<span class=c1>// (example: single batch of 10 values)</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span> <span class=n>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>10</span> <span class=p>});</span>


<span class=c1>// fill the tensor with your input data</span>
<span class=c1>// (example: just fill consecutive values)</span>
<span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// run the evaluation</span>
<span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span> <span class=n>outputs</span><span class=p>;</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=p>{</span> <span class=p>{</span> <span class=s>&quot;input&quot;</span><span class=p>,</span> <span class=n>input</span> <span class=p>}</span> <span class=p>},</span> <span class=p>{</span> <span class=s>&quot;output&quot;</span> <span class=p>},</span> <span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

<span class=c1>// process the output tensor</span>
<span class=c1>// (example: print the 5th value of the 0th (the only) example)</span>
<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=c1>// -&gt; float</span>
</code></pre></div> </td></tr></table> <h5 id=4-cleanup>4. Cleanup<a class=headerlink href=#4-cleanup title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=n>tensorflow</span><span class=o>::</span><span class=n>closeSession</span><span class=p>(</span><span class=n>session</span><span class=p>);</span>
<span class=k>delete</span> <span class=n>graphDef</span><span class=p>;</span>
</code></pre></div> </td></tr></table> <h5 id=full-example>Full example<a class=headerlink href=#full-example title="Permanent link">&para;</a></h5> <details class=hint><summary>Click to expand</summary><p>The example assumes the following directory structure:</p> <div class=highlight><pre><span></span><code>MySubsystem/MyModule/
│
├── plugins/
│   ├── MyPlugin.cpp
│   └── BuildFile.xml
│
├── test/
│   └── my_plugin_cfg.py
│
└── data/
    └── graph.pb
</code></pre></div> <div class=tabbed-set data-tabs=3:3><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><label for=__tabbed_3_1>plugins/MyPlugin.cpp</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=cm>/*</span>
<span class=hll><span class=cm> * Example plugin to demonstrate the direct single-threaded inference with TensorFlow 2.</span>
</span><span class=cm> */</span>

<span class=cp>#include</span> <span class=cpf>&lt;memory&gt;</span><span class=cp></span>

<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/Event.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/Frameworkfwd.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/MakerMacros.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/one/EDAnalyzer.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/ParameterSet/interface/ParameterSet.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span><span class=cp></span>

<span class=k>class</span> <span class=nc>MyPlugin</span> <span class=o>:</span> <span class=k>public</span> <span class=n>edm</span><span class=o>::</span><span class=n>one</span><span class=o>::</span><span class=n>EDAnalyzer</span><span class=o>&lt;&gt;</span> <span class=p>{</span>
<span class=k>public</span><span class=o>:</span>
  <span class=k>explicit</span> <span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>);</span>
  <span class=o>~</span><span class=n>MyPlugin</span><span class=p>(){};</span>

  <span class=k>static</span> <span class=kt>void</span> <span class=nf>fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span><span class=p>);</span>

<span class=k>private</span><span class=o>:</span>
  <span class=kt>void</span> <span class=n>beginJob</span><span class=p>();</span>
  <span class=kt>void</span> <span class=nf>analyze</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span><span class=p>,</span> <span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span><span class=p>);</span>
  <span class=kt>void</span> <span class=nf>endJob</span><span class=p>();</span>

  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>graphPath_</span><span class=p>;</span>
  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>inputTensorName_</span><span class=p>;</span>
  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>outputTensorName_</span><span class=p>;</span>

  <span class=n>tensorflow</span><span class=o>::</span><span class=n>GraphDef</span><span class=o>*</span> <span class=n>graphDef_</span><span class=p>;</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span> <span class=n>session_</span><span class=p>;</span>
<span class=p>};</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span> <span class=n>descriptions</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// defining this function will lead to a *_cfi file being generated when compiling</span>
  <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSetDescription</span> <span class=n>desc</span><span class=p>;</span>
  <span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>);</span>
  <span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>);</span>
  <span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>);</span>
  <span class=n>descriptions</span><span class=p>.</span><span class=n>addWithDefaultLabel</span><span class=p>(</span><span class=n>desc</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MyPlugin</span><span class=o>::</span><span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span> <span class=n>config</span><span class=p>)</span>
    <span class=o>:</span> <span class=n>graphPath_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>)),</span>
      <span class=n>inputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>)),</span>
      <span class=n>outputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>)),</span>
      <span class=n>graphDef_</span><span class=p>(</span><span class=k>nullptr</span><span class=p>),</span>
      <span class=n>session_</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// set tensorflow log leven to warning</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=s>&quot;2&quot;</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>beginJob</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// load the graph</span>
  <span class=n>graphDef_</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>loadGraphDef</span><span class=p>(</span><span class=n>graphPath_</span><span class=p>);</span>

  <span class=c1>// create a new session and add the graphDef</span>
  <span class=n>session_</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef_</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>endJob</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// close the session</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>closeSession</span><span class=p>(</span><span class=n>session_</span><span class=p>);</span>

  <span class=c1>// delete the graph</span>
  <span class=k>delete</span> <span class=n>graphDef_</span><span class=p>;</span>
  <span class=n>graphDef_</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>analyze</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span> <span class=n>event</span><span class=p>,</span> <span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span> <span class=n>setup</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// define a tensor and fill it with range(10)</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span> <span class=n>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>});</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// define the output and run</span>
  <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span> <span class=n>outputs</span><span class=p>;</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session_</span><span class=p>,</span> <span class=p>{{</span><span class=n>inputTensorName_</span><span class=p>,</span> <span class=n>input</span><span class=p>}},</span> <span class=p>{</span><span class=n>outputTensorName_</span><span class=p>},</span> <span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

  <span class=c1>// print the output</span>
  <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&quot; -&gt; &quot;</span> <span class=o>&lt;&lt;</span> <span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>DEFINE_FWK_MODULE</span><span class=p>(</span><span class=n>MyPlugin</span><span class=p>);</span>
</code></pre></div> </td></tr></table> </div> <input id=__tabbed_3_2 name=__tabbed_3 type=radio><label for=__tabbed_3_2>plugins/BuildFile.xml</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;FWCore/Framework&quot;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;FWCore/PluginManager&quot;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;FWCore/ParameterSet&quot;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span> <span class=nt>/&gt;</span>

<span class=nt>&lt;flags</span> <span class=na>EDM_PLUGIN=</span><span class=s>&quot;1&quot;</span> <span class=nt>/&gt;</span>
</code></pre></div> </td></tr></table> </div> <input id=__tabbed_3_3 name=__tabbed_3 type=radio><label for=__tabbed_3_3>test/my_plugin_cfg.py</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>os</span>

<span class=kn>import</span> <span class=nn>FWCore.ParameterSet.Config</span> <span class=k>as</span> <span class=nn>cms</span>
<span class=kn>from</span> <span class=nn>FWCore.ParameterSet.VarParsing</span> <span class=kn>import</span> <span class=n>VarParsing</span>


<span class=c1># get the data/ directory</span>
<span class=n>thisdir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=vm>__file__</span><span class=p>))</span>
<span class=n>datadir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>thisdir</span><span class=p>),</span> <span class=s2>&quot;data&quot;</span><span class=p>)</span>

<span class=c1># setup minimal options</span>
<span class=n>options</span> <span class=o>=</span> <span class=n>VarParsing</span><span class=p>(</span><span class=s2>&quot;python&quot;</span><span class=p>)</span>
<span class=n>options</span><span class=o>.</span><span class=n>setDefault</span><span class=p>(</span><span class=s2>&quot;inputFiles&quot;</span><span class=p>,</span> <span class=s2>&quot;root://xrootd-cms.infn.it//store/mc/RunIIFall17MiniAOD/DYJetsToLL_M-10to50_TuneCP5_13TeV-madgraphMLM-pythia8/MINIAODSIM/94X_mc2017_realistic_v10-v2/00000/9A439935-1FFF-E711-AE07-D4AE5269F5FF.root&quot;</span><span class=p>)</span>  <span class=c1># noqa</span>
<span class=n>options</span><span class=o>.</span><span class=n>parseArguments</span><span class=p>()</span>

<span class=c1># define the process to run</span>
<span class=n>process</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=s2>&quot;TEST&quot;</span><span class=p>)</span>

<span class=c1># minimal configuration</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;FWCore.MessageService.MessageLogger_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>MessageLogger</span><span class=o>.</span><span class=n>cerr</span><span class=o>.</span><span class=n>FwkReport</span><span class=o>.</span><span class=n>reportEvery</span> <span class=o>=</span> <span class=mi>1</span>
<span class=n>process</span><span class=o>.</span><span class=n>maxEvents</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>int32</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span>
<span class=n>process</span><span class=o>.</span><span class=n>source</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Source</span><span class=p>(</span><span class=s2>&quot;PoolSource&quot;</span><span class=p>,</span>
    <span class=n>fileNames</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>vstring</span><span class=p>(</span><span class=n>options</span><span class=o>.</span><span class=n>inputFiles</span><span class=p>))</span>

<span class=c1># process options</span>
<span class=n>process</span><span class=o>.</span><span class=n>options</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span>
    <span class=n>allowUnscheduled</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
    <span class=n>wantSummary</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
<span class=p>)</span>

<span class=c1># setup MyPlugin by loading the auto-generated cfi (see MyPlugin.fillDescriptions)</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;MySubsystem.MyModule.myPlugin_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>graphPath</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>datadir</span><span class=p>,</span> <span class=s2>&quot;graph.pb&quot;</span><span class=p>))</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>inputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;input&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>outputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;output&quot;</span><span class=p>)</span>

<span class=c1># define what to run in the path</span>
<span class=n>process</span><span class=o>.</span><span class=n>p</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=p>)</span>
</code></pre></div> </td></tr></table> </div> </div> </details> <h3 id=multi-threaded-inference>Multi-threaded inference<a class=headerlink href=#multi-threaded-inference title="Permanent link">&para;</a></h3> <p>Compared to the single-threaded implementation <a href=#single-threaded-inference>above</a>, the multi-threaded version has one major difference: <mark>the <code>Graph</code> is no longer a member of a particular module instance, but rather shared between all instances in all threads</mark>. This is possible since the <code>Graph</code> is actually a constant object that does not change over the course of the inference process. All volatile, device dependent information is kept in a <code>Session</code> which we keep instantiating per module instance. The <code>Graph</code> on the other hand is stored in a <code class=highlight><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span></code>. See the documentation on the <a href=https://twiki.cern.ch/twiki/bin/view/CMSPublic/FWMultithreadedFrameworkStreamModuleInterface>C++ interface of <code>stream</code> modules</a> for details.</p> <p>Thus, the overall inference approach is <strong>1)</strong> include the interface, <strong>2)</strong> define the <code class=highlight><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span></code> holding the <code>Graph</code>, <strong>3)</strong> initialize the <code>Session</code> with the cached <code>Graph</code>, <strong>4)</strong> per event create input tensors and run the inference, and <strong>5)</strong> cleanup.</p> <h5 id=1-includes_1>1. Includes<a class=headerlink href=#1-includes_1 title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=cp>#include</span> <span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span><span class=cp></span>
<span class=hll><span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/stream/EDAnalyzer.h&quot;</span><span class=cp></span>
</span><span class=c1>// further framework includes</span>
<span class=p>...</span>
</code></pre></div> </td></tr></table> <p>Note that <code>stream/EDAnalyzer.h</code> is included rather than <code>one/EDAnalyzer.h</code>.</p> <h5 id=2-define-and-use-the-cache>2. Define and use the cache<a class=headerlink href=#2-define-and-use-the-cache title="Permanent link">&para;</a></h5> <p>The cache definition is done by declaring a simle struct.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=k>struct</span> <span class=n>MyCache</span> <span class=p>{</span>
  <span class=n>MyCache</span><span class=p>()</span> <span class=o>:</span> <span class=n>graphDef</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span> <span class=p>{}</span>
  <span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>GraphDef</span><span class=o>*&gt;</span> <span class=n>graphDef</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div> </td></tr></table> <p>Use it in the <code class=highlight><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span></code> template argument and adjust the plugin accordingly.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>MyPlugin</span> <span class=o>:</span> <span class=k>public</span> <span class=n>edm</span><span class=o>::</span><span class=n>stream</span><span class=o>::</span><span class=n>EDAnalyzer</span><span class=o>&lt;</span><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;&gt;</span> <span class=p>{</span>
<span class=k>public</span><span class=o>:</span>
    <span class=k>explicit</span> <span class=n>GraphLoadingMT</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>,</span> <span class=k>const</span> <span class=n>CacheData</span><span class=o>*</span><span class=p>);</span>
    <span class=o>~</span><span class=n>GraphLoadingMT</span><span class=p>();</span>

    <span class=c1>// two additional static methods for handling the global cache</span>
    <span class=k>static</span> <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;</span> <span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>);</span>
    <span class=k>static</span> <span class=kt>void</span> <span class=nf>globalEndJob</span><span class=p>(</span><span class=k>const</span> <span class=n>CacheData</span><span class=o>*</span><span class=p>);</span>
<span class=p>...</span>
</code></pre></div> </td></tr></table> <p>Implement <code>initializeGlobalCache</code> and <code>globalEndJob</code> to control the behavior of how the cache object is created and destroyed.</p> <p>See the <a href=#full-example_1>full example</a> below for details.</p> <h5 id=3-initialize-objects>3. Initialize objects<a class=headerlink href=#3-initialize-objects title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1>// configure logging to show warnings (see table below)</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=s>&quot;2&quot;</span><span class=p>);</span>

<span class=c1>// create a session using the graphDef stored in the cache</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span> <span class=n>session</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>cacheData</span><span class=o>-&gt;</span><span class=n>graphDef</span><span class=p>);</span>
</code></pre></div> </td></tr></table> <h5 id=4-inference>4. Inference<a class=headerlink href=#4-inference title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1>// create an input tensor</span>
<span class=c1>// (example: single batch of 10 values)</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span> <span class=n>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>10</span> <span class=p>});</span>


<span class=c1>// fill the tensor with your input data</span>
<span class=c1>// (example: just fill consecutive values)</span>
<span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// run the evaluation</span>
<span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span> <span class=n>outputs</span><span class=p>;</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=p>{</span> <span class=p>{</span> <span class=n>inputTensorName</span><span class=p>,</span> <span class=n>input</span> <span class=p>}</span> <span class=p>},</span> <span class=p>{</span> <span class=n>outputTensorName</span> <span class=p>},</span> <span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

<span class=c1>// process the output tensor</span>
<span class=c1>// (example: print the 5th value of the 0th (the only) example)</span>
<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=c1>// -&gt; float</span>
</code></pre></div> </td></tr></table> <h5 id=5-cleanup>5. Cleanup<a class=headerlink href=#5-cleanup title="Permanent link">&para;</a></h5> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1>// per module instance</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>closeSession</span><span class=p>(</span><span class=n>session_</span><span class=p>);</span>

<span class=c1>// in globalEndJob</span>
<span class=k>delete</span> <span class=n>cacheData</span><span class=o>-&gt;</span><span class=n>graphDef</span><span class=p>;</span>
</code></pre></div> </td></tr></table> <h5 id=full-example_1>Full example<a class=headerlink href=#full-example_1 title="Permanent link">&para;</a></h5> <details class=hint><summary>Click to expand</summary><p>The example assumes the following directory structure:</p> <div class=highlight><pre><span></span><code>MySubsystem/MyModule/
│
├── plugins/
│   ├── MyPlugin.cpp
│   └── BuildFile.xml
│
├── test/
│   └── my_plugin_cfg.py
│
└── data/
    └── graph.pb
</code></pre></div> <div class=tabbed-set data-tabs=4:3><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><label for=__tabbed_4_1>plugins/MyPlugin.cpp</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=cm>/*</span>
<span class=hll><span class=cm> * Example plugin to demonstrate the direct multi-threaded inference with TensorFlow 2.</span>
</span><span class=cm> */</span>

<span class=cp>#include</span> <span class=cpf>&lt;memory&gt;</span><span class=cp></span>

<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/Event.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/Frameworkfwd.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/MakerMacros.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/Framework/interface/stream/EDAnalyzer.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;FWCore/ParameterSet/interface/ParameterSet.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span><span class=cp></span>

<span class=c1>// define the cache object</span>
<span class=c1>// it could handle graph loading and destruction on its own,</span>
<span class=c1>// but in this example, we define it as a logicless container</span>
<span class=k>struct</span> <span class=n>CacheData</span> <span class=p>{</span>
  <span class=n>CacheData</span><span class=p>()</span> <span class=o>:</span> <span class=n>graphDef</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span> <span class=p>{}</span>
  <span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>GraphDef</span><span class=o>*&gt;</span> <span class=n>graphDef</span><span class=p>;</span>
<span class=p>};</span>

<span class=k>class</span> <span class=nc>MyPlugin</span> <span class=o>:</span> <span class=k>public</span> <span class=n>edm</span><span class=o>::</span><span class=n>stream</span><span class=o>::</span><span class=n>EDAnalyzer</span><span class=o>&lt;</span><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;&gt;</span> <span class=p>{</span>
<span class=k>public</span><span class=o>:</span>
  <span class=k>explicit</span> <span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>,</span> <span class=k>const</span> <span class=n>CacheData</span><span class=o>*</span><span class=p>);</span>
  <span class=o>~</span><span class=n>MyPlugin</span><span class=p>(){};</span>

  <span class=k>static</span> <span class=kt>void</span> <span class=nf>fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span><span class=p>);</span>

  <span class=c1>// two additional static methods for handling the global cache</span>
  <span class=k>static</span> <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;</span> <span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>);</span>
  <span class=k>static</span> <span class=kt>void</span> <span class=nf>globalEndJob</span><span class=p>(</span><span class=k>const</span> <span class=n>CacheData</span><span class=o>*</span><span class=p>);</span>

<span class=k>private</span><span class=o>:</span>
  <span class=kt>void</span> <span class=n>beginJob</span><span class=p>();</span>
  <span class=kt>void</span> <span class=nf>analyze</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span><span class=p>,</span> <span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span><span class=p>);</span>
  <span class=kt>void</span> <span class=nf>endJob</span><span class=p>();</span>

  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>inputTensorName_</span><span class=p>;</span>
  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>outputTensorName_</span><span class=p>;</span>

  <span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span> <span class=n>session_</span><span class=p>;</span>
<span class=p>};</span>

<span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span> <span class=n>config</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// this method is supposed to create, initialize and return a CacheData instance</span>
  <span class=n>CacheData</span><span class=o>*</span> <span class=n>cacheData</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CacheData</span><span class=p>();</span>

  <span class=c1>// load the graph def and save it</span>
  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>graphPath</span> <span class=o>=</span> <span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>);</span>
  <span class=n>cacheData</span><span class=o>-&gt;</span><span class=n>graphDef</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>loadGraphDef</span><span class=p>(</span><span class=n>graphPath</span><span class=p>);</span>

  <span class=c1>// set tensorflow log leven to warning</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=s>&quot;2&quot;</span><span class=p>);</span>

  <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cacheData</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>globalEndJob</span><span class=p>(</span><span class=k>const</span> <span class=n>CacheData</span><span class=o>*</span> <span class=n>cacheData</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// reset the graphDef</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cacheData</span><span class=o>-&gt;</span><span class=n>graphDef</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>delete</span> <span class=n>cacheData</span><span class=o>-&gt;</span><span class=n>graphDef</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span> <span class=n>descriptions</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// defining this function will lead to a *_cfi file being generated when compiling</span>
  <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSetDescription</span> <span class=n>desc</span><span class=p>;</span>
  <span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>);</span>
  <span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>);</span>
  <span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>);</span>
  <span class=n>descriptions</span><span class=p>.</span><span class=n>addWithDefaultLabel</span><span class=p>(</span><span class=n>desc</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MyPlugin</span><span class=o>::</span><span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span> <span class=n>config</span><span class=p>,</span> <span class=k>const</span> <span class=n>CacheData</span><span class=o>*</span> <span class=n>cacheData</span><span class=p>)</span>
    <span class=o>:</span> <span class=n>inputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>)),</span>
      <span class=n>outputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>)),</span>
      <span class=n>session_</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>cacheData</span><span class=o>-&gt;</span><span class=n>graphDef</span><span class=p>))</span> <span class=p>{}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>beginJob</span><span class=p>()</span> <span class=p>{}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>endJob</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// close the session</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>closeSession</span><span class=p>(</span><span class=n>session_</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=n>MyPlugin</span><span class=o>::</span><span class=n>analyze</span><span class=p>(</span><span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span> <span class=n>event</span><span class=p>,</span> <span class=k>const</span> <span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span> <span class=n>setup</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// define a tensor and fill it with range(10)</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span> <span class=n>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>});</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// define the output and run</span>
  <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span> <span class=n>outputs</span><span class=p>;</span>
  <span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session_</span><span class=p>,</span> <span class=p>{{</span><span class=n>inputTensorName_</span><span class=p>,</span> <span class=n>input</span><span class=p>}},</span> <span class=p>{</span><span class=n>outputTensorName_</span><span class=p>},</span> <span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

  <span class=c1>// print the output</span>
  <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&quot; -&gt; &quot;</span> <span class=o>&lt;&lt;</span> <span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>DEFINE_FWK_MODULE</span><span class=p>(</span><span class=n>MyPlugin</span><span class=p>);</span>
</code></pre></div> </td></tr></table> </div> <input id=__tabbed_4_2 name=__tabbed_4 type=radio><label for=__tabbed_4_2>plugins/BuildFile.xml</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;FWCore/Framework&quot;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;FWCore/PluginManager&quot;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;FWCore/ParameterSet&quot;</span> <span class=nt>/&gt;</span>
<span class=nt>&lt;use</span> <span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span> <span class=nt>/&gt;</span>

<span class=nt>&lt;flags</span> <span class=na>EDM_PLUGIN=</span><span class=s>&quot;1&quot;</span> <span class=nt>/&gt;</span>
</code></pre></div> </td></tr></table> </div> <input id=__tabbed_4_3 name=__tabbed_4 type=radio><label for=__tabbed_4_3>test/my_plugin_cfg.py</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>os</span>

<span class=kn>import</span> <span class=nn>FWCore.ParameterSet.Config</span> <span class=k>as</span> <span class=nn>cms</span>
<span class=kn>from</span> <span class=nn>FWCore.ParameterSet.VarParsing</span> <span class=kn>import</span> <span class=n>VarParsing</span>


<span class=c1># get the data/ directory</span>
<span class=n>thisdir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=vm>__file__</span><span class=p>))</span>
<span class=n>datadir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>thisdir</span><span class=p>),</span> <span class=s2>&quot;data&quot;</span><span class=p>)</span>

<span class=c1># setup minimal options</span>
<span class=n>options</span> <span class=o>=</span> <span class=n>VarParsing</span><span class=p>(</span><span class=s2>&quot;python&quot;</span><span class=p>)</span>
<span class=n>options</span><span class=o>.</span><span class=n>setDefault</span><span class=p>(</span><span class=s2>&quot;inputFiles&quot;</span><span class=p>,</span> <span class=s2>&quot;root://xrootd-cms.infn.it//store/mc/RunIIFall17MiniAOD/DYJetsToLL_M-10to50_TuneCP5_13TeV-madgraphMLM-pythia8/MINIAODSIM/94X_mc2017_realistic_v10-v2/00000/9A439935-1FFF-E711-AE07-D4AE5269F5FF.root&quot;</span><span class=p>)</span>  <span class=c1># noqa</span>
<span class=n>options</span><span class=o>.</span><span class=n>parseArguments</span><span class=p>()</span>

<span class=c1># define the process to run</span>
<span class=n>process</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=s2>&quot;TEST&quot;</span><span class=p>)</span>

<span class=c1># minimal configuration</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;FWCore.MessageService.MessageLogger_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>MessageLogger</span><span class=o>.</span><span class=n>cerr</span><span class=o>.</span><span class=n>FwkReport</span><span class=o>.</span><span class=n>reportEvery</span> <span class=o>=</span> <span class=mi>1</span>
<span class=n>process</span><span class=o>.</span><span class=n>maxEvents</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span><span class=nb>input</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>int32</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span>
<span class=n>process</span><span class=o>.</span><span class=n>source</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Source</span><span class=p>(</span><span class=s2>&quot;PoolSource&quot;</span><span class=p>,</span>
    <span class=n>fileNames</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>vstring</span><span class=p>(</span><span class=n>options</span><span class=o>.</span><span class=n>inputFiles</span><span class=p>))</span>

<span class=c1># process options</span>
<span class=n>process</span><span class=o>.</span><span class=n>options</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span>
    <span class=n>allowUnscheduled</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
    <span class=n>wantSummary</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
<span class=p>)</span>

<span class=c1># setup MyPlugin by loading the auto-generated cfi (see MyPlugin.fillDescriptions)</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;MySubsystem.MyModule.myPlugin_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>graphPath</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>datadir</span><span class=p>,</span> <span class=s2>&quot;graph.pb&quot;</span><span class=p>))</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>inputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;input&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>outputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;output&quot;</span><span class=p>)</span>

<span class=c1># define what to run in the path</span>
<span class=n>process</span><span class=o>.</span><span class=n>p</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=p>)</span>
</code></pre></div> </td></tr></table> </div> </div> </details> <h3 id=optimization>Optimization<a class=headerlink href=#optimization title="Permanent link">&para;</a></h3> <p>Depending on the use case, the following approaches can optimize the inference performance. It could be worth checking them out in your algorithm.</p> <p>Further optimization approaches can be found in the <a href=checklist.html>integration checklist</a>.</p> <h4 id=reusing-tensors>Reusing tensors<a class=headerlink href=#reusing-tensors title="Permanent link">&para;</a></h4> <p>In some cases, instead of creating new input tensors for each inference call, you might want to store input tensors as members of your plugin. This is of course possible if you know its exact shape a-prioro and comes with the cost of keeping the tensor in memory for the lifetime of your module instance.</p> <p>You can use</p> <div class=highlight><pre><span></span><code><span class=n>tensor</span><span class=p>.</span><span class=n>flat</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>().</span><span class=n>setZero</span><span class=p>();</span>
</code></pre></div> <p>to reset the values of your tensor prior to each call.</p> <h4 id=tensor-data-access-via-pointers>Tensor data access via pointers<a class=headerlink href=#tensor-data-access-via-pointers title="Permanent link">&para;</a></h4> <p>As shown in the examples above, tensor data can be accessed through methods such as <code>flat&lt;type&gt;()</code> or <code>matrix&lt;type&gt;()</code> which return objects that represent the underlying data in the requested structure (<a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/tensor><code>tensorflow::Tensor</code> C++ API</a>). To read and manipulate particular elements, you can directly call this object with the coordinates of an element.</p> <div class=highlight><pre><span></span><code><span class=c1>// matrix returns a 2D representation</span>
<span class=c1>// set element (b,i) to f</span>
<span class=n>tensor</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=n>b</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=kt>float</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</code></pre></div> <p>However, doing this for a large input tensor might entail some overhead. Since the data is actually contiguous in memory (C-style "row-major" memory ordering), a faster (though less explicit) way of interacting with tensor data is using a pointer.</p> <div class=highlight><pre><span></span><code><span class=c1>// get the pointer to the first tensor element</span>
<span class=kt>float</span><span class=o>*</span> <span class=n>d</span> <span class=o>=</span> <span class=n>tensor</span><span class=p>.</span><span class=n>flat</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>().</span><span class=n>data</span><span class=p>();</span>
</code></pre></div> <p>Now, the tensor data can be filled using simple and fast pointer arithmetic.</p> <div class=highlight><pre><span></span><code><span class=c1>// fill tensor data using pointer arithmethic</span>
<span class=c1>// memory ordering is row-major, so the most outer loop corresponds dimension 0</span>
<span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>b</span> <span class=o>&lt;</span> <span class=n>batchSize</span><span class=p>;</span> <span class=n>b</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>nFeatures</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>,</span> <span class=n>d</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// note the d++</span>
<span class=hll>        <span class=o>*</span><span class=n>d</span> <span class=o>=</span> <span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span>    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <h4 id=inter-and-intra-operation-parallelism>Inter- and intra-operation parallelism<a class=headerlink href=#inter-and-intra-operation-parallelism title="Permanent link">&para;</a></h4> <div class="admonition danger"> <p class=admonition-title>Debugging and local processing only</p> <p>Parallelism between (inter) and within (intra) operations can greatly improve the inference performance. However, this allows TensorFlow to manage and schedule threads on its own, possibly interfering with the thread model inherent to CMSSW. For inference code that is to be officially integrated, you should <mark>avoid</mark> inter- and intra-op parallelism and rather adhere to the examples shown above.</p> </div> <p>You can configure the amount of inter- and infra-op threads via the second argument of the <code class=highlight><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span></code> method.</p> <div class=tabbed-set data-tabs=5:2><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><label for=__tabbed_5_1>Simple</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span> <span class=n>session</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef</span><span class=p>,</span> <span class=n>nThreads</span><span class=p>);</span>
</code></pre></div> </td></tr></table> </div> <input id=__tabbed_5_2 name=__tabbed_5 type=radio><label for=__tabbed_5_2>Verbose</label><div class=tabbed-content> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionOptions</span> <span class=n>sessionOptions</span><span class=p>;</span>
<span class=n>sessionOptions</span><span class=p>.</span><span class=n>config</span><span class=p>.</span><span class=n>set_intra_op_parallelism_threads</span><span class=p>(</span><span class=n>nThreads</span><span class=p>);</span>
<span class=n>sessionOptions</span><span class=p>.</span><span class=n>config</span><span class=p>.</span><span class=n>set_inter_op_parallelism_threads</span><span class=p>(</span><span class=n>nThreads</span><span class=p>);</span>

<span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span> <span class=n>session</span> <span class=o>=</span> <span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef</span><span class=p>,</span> <span class=n>sessionOptions</span><span class=p>);</span>
</code></pre></div> </td></tr></table> </div> </div> <p>Then, when calling <code class=highlight><span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span></code>, pass the internal name of the TensorFlow threadpool, i.e. <code>"tensorflow"</code>, as the last argument.</p> <table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=highlight><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span> <span class=n>outputs</span><span class=p>;</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span>
    <span class=n>session</span><span class=p>,</span>
    <span class=p>{</span> <span class=p>{</span> <span class=n>inputTensorName</span><span class=p>,</span> <span class=n>input</span> <span class=p>}</span> <span class=p>},</span>
    <span class=p>{</span> <span class=n>outputTensorName</span> <span class=p>},</span>
    <span class=o>&amp;</span><span class=n>outputs</span><span class=p>,</span>
    <span class=s>&quot;tensorflow&quot;</span>
<span class=p>);</span>
</code></pre></div> </td></tr></table> <h2 id=miscellaneous>Miscellaneous<a class=headerlink href=#miscellaneous title="Permanent link">&para;</a></h2> <h3 id=logging>Logging<a class=headerlink href=#logging title="Permanent link">&para;</a></h3> <p>By default, TensorFlow logging is quite verbose. This can be changed by either setting the <code>TF_CPP_MIN_LOG_LEVEL</code> environment varibale before calling <code>cmsRun</code>, or within your code through <code class=highlight><span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=n>level</span><span class=p>)</span></code>.</p> <table> <thead> <tr> <th>Verbosity level</th> <th><code>TF_CPP_MIN_LOG_LEVEL</code></th> </tr> </thead> <tbody> <tr> <td>debug</td> <td>"0"</td> </tr> <tr> <td>info</td> <td>"1" (default)</td> </tr> <tr> <td>warning</td> <td>"2"</td> </tr> <tr> <td>error</td> <td>"3"</td> </tr> <tr> <td>none</td> <td>"4"</td> </tr> </tbody> </table> <p>Forwarding logs to the <code>MessageLogger</code> service is not possible yet.</p> <h2 id=links-and-further-reading>Links and further reading<a class=headerlink href=#links-and-further-reading title="Permanent link">&para;</a></h2> <ul> <li><a href=https://cmsml.readthedocs.io><code>cmsml</code> package</a></li> <li>CMSSW<ul> <li><a href=http://cmsdoxygen.web.cern.ch/cmsdoxygen/CMSSW_11_1_2/doc/html/de/d86/namespacetensorflow.html>TensorFlow interface documentation</a></li> <li><a href=https://github.com/cms-sw/cmssw/blob/master/PhysicsTools/TensorFlow/interface/TensorFlow.h>TensorFlow interface header</a></li> <li><a href=https://twiki.cern.ch/twiki/bin/view/CMSPublic/SWGuideEDMParametersForModules#The_options_Parameter_Set>CMSSW process options</a></li> <li><a href=https://twiki.cern.ch/twiki/bin/view/CMSPublic/FWMultithreadedFrameworkStreamModuleInterface>C++ interface of <code>stream</code> modules</a></li> </ul> </li> <li>TensorFlow<ul> <li><a href=https://indico.cern.ch/event/882992/contributions/3721506/attachments/1994721/3327402/TensorFlow_2_Workshop_CERN_2020.pdf>TensorFlow 2 tutorial</a></li> <li><a href=https://www.tensorflow.org/guide/function><code>tf.function</code></a></li> <li><a href=https://www.tensorflow.org/api_docs/cc>C++ API</a></li> <li><a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/tensor><code>tensorflow::Tensor</code></a></li> <li><a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/operation><code>tensorflow::Operation</code></a></li> <li><a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/client-session><code>tensorflow::ClientSession</code></a></li> </ul> </li> <li>Keras<ul> <li><a href=https://keras.io/api>API</a></li> </ul> </li> </ul> <hr> <p>Authors: <a href=mailto:marcel.rieger@cern.ch>Marcel Rieger</a></p> <hr> <div class=md-source-date> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 30, 2021</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=tensorflow1.html title="TensorFlow 1" class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Previous </span> TensorFlow 1 </div> </div> </a> <a href=onnx.html title=ONNX class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Next </span> ONNX </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 CMS Machine Learning Group </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/cms-ml target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://hub.docker.com/orgs/cmsml/repositories target=_blank rel=noopener title=hub.docker.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg> </a> <a href=https://hypernews.cern.ch/HyperNews/CMS/get/machine-learning.html target=_blank rel=noopener title=hypernews.cern.ch class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32zM128 272c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm128 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"/></svg> </a> <a href=mailto:hn-cms-machine-learning@cern.ch target=_blank rel=noopener title class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../assets/javascripts/vendor.c3dc8c49.min.js></script> <script src=../assets/javascripts/bundle.f9edbbd5.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "..",
          features: ["instant"],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> <script src=https://unpkg.com/mermaid@8.6/dist/mermaid.min.js></script> </body> </html>