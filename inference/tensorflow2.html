<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation of the CMS Machine Learning Group"><meta name=author content="CMS Machine Learning Group"><link rel=canonical href=https://cms-ml.github.io/documentation/inference/tensorflow2.html><link rel=prev href=../general_advice/after/after.html><link rel=next href=tensorflow_aot.html><link rel=icon href=../images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.23"><title>TensorFlow 2 - CMS Machine Learning Documentation</title><link rel=stylesheet href=../assets/stylesheets/main.6543a935.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../termynal.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=orange> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#direct-inference-with-tensorflow-2 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title="CMS Machine Learning Documentation" class="md-header__button md-logo" aria-label="CMS Machine Learning Documentation" data-md-component=logo> <img src=../images/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> CMS Machine Learning Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> TensorFlow 2 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/cms-ml/documentation title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> cms-ml/documentation </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title="CMS Machine Learning Documentation" class="md-nav__button md-logo" aria-label="CMS Machine Learning Documentation" data-md-component=logo> <img src=../images/logo.png alt=logo> </a> CMS Machine Learning Documentation </label> <div class=md-nav__source> <a href=https://github.com/cms-ml/documentation title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> cms-ml/documentation </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Innovation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Innovation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../innovation/journal_club.html class=md-nav__link> <span class=md-ellipsis> ML Journal Club </span> </a> </li> <li class=md-nav__item> <a href=../innovation/hackathons.html class=md-nav__link> <span class=md-ellipsis> ML Hackathons </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../resources/cloud_resources/index.html class=md-nav__link> <span class=md-ellipsis> Cloud Resources </span> </a> </li> <li class=md-nav__item> <a href=../resources/dataset_resources/index.html class=md-nav__link> <span class=md-ellipsis> Dataset Resources </span> </a> </li> <li class=md-nav__item> <a href=../resources/fpga_resources/index.html class=md-nav__link> <span class=md-ellipsis> FPGA Resource </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class=md-ellipsis> GPU Resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> GPU Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../resources/gpu_resources/cms_resources/lxplus_gpu.html class=md-nav__link> <span class=md-ellipsis> lxplus-gpu </span> </a> </li> <li class=md-nav__item> <a href=../resources/gpu_resources/cms_resources/lxplus_htcondor.html class=md-nav__link> <span class=md-ellipsis> CERN HTCondor </span> </a> </li> <li class=md-nav__item> <a href=../resources/gpu_resources/cms_resources/swan.html class=md-nav__link> <span class=md-ellipsis> SWAN </span> </a> </li> <li class=md-nav__item> <a href=../resources/gpu_resources/cms_resources/ml_cern_ch.html class=md-nav__link> <span class=md-ellipsis> ml.cern.ch </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Guides </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex=0> <span class=md-ellipsis> Software environments </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Software environments </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../software_envs/lcg_environments.html class=md-nav__link> <span class=md-ellipsis> LCG environments </span> </a> </li> <li class=md-nav__item> <a href=../software_envs/containers.html class=md-nav__link> <span class=md-ellipsis> Using containers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Optimization </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Optimization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../optimization/model_optimization.html class=md-nav__link> <span class=md-ellipsis> Model optimization </span> </a> </li> <li class=md-nav__item> <a href=../optimization/importance.html class=md-nav__link> <span class=md-ellipsis> Feature importance </span> </a> </li> <li class=md-nav__item> <a href=../optimization/data_augmentation.html class=md-nav__link> <span class=md-ellipsis> Data augmentation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> General Advice </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> General Advice </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../general_advice/intro.html class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3_2> <label class=md-nav__link for=__nav_4_3_2 id=__nav_4_3_2_label tabindex=0> <span class=md-ellipsis> Before training </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3_2> <span class="md-nav__icon md-icon"></span> Before training </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../general_advice/before/domains.html class=md-nav__link> <span class=md-ellipsis> Domains </span> </a> </li> <li class=md-nav__item> <a href=../general_advice/before/features.html class=md-nav__link> <span class=md-ellipsis> Features </span> </a> </li> <li class=md-nav__item> <a href=../general_advice/before/inputs.html class=md-nav__link> <span class=md-ellipsis> Inputs </span> </a> </li> <li class=md-nav__item> <a href=../general_advice/before/model.html class=md-nav__link> <span class=md-ellipsis> Model </span> </a> </li> <li class=md-nav__item> <a href=../general_advice/before/metrics.html class=md-nav__link> <span class=md-ellipsis> Metrics & Losses </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3_3> <label class=md-nav__link for=__nav_4_3_3 id=__nav_4_3_3_label tabindex=0> <span class=md-ellipsis> During training </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3_3> <span class="md-nav__icon md-icon"></span> During training </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../general_advice/during/overfitting.html class=md-nav__link> <span class=md-ellipsis> Overfitting </span> </a> </li> <li class=md-nav__item> <a href=../general_advice/during/xvalidation.html class=md-nav__link> <span class=md-ellipsis> Cross-validation </span> </a> </li> <li class=md-nav__item> <a href=../general_advice/during/opt.html class=md-nav__link> <span class=md-ellipsis> Optimisation problems </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../general_advice/after/after.html class=md-nav__link> <span class=md-ellipsis> After training </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4 checked> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> <span class=md-ellipsis> Inference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Inference </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4_1 checked> <label class=md-nav__link for=__nav_4_4_1 id=__nav_4_4_1_label tabindex=0> <span class=md-ellipsis> Direct inference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_4_1_label aria-expanded=true> <label class=md-nav__title for=__nav_4_4_1> <span class="md-nav__icon md-icon"></span> Direct inference </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> TensorFlow 2 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=tensorflow2.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> TensorFlow 2 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#available-versions class=md-nav__link> <span class=md-ellipsis> Available versions </span> </a> </li> <li class=md-nav__item> <a href=#software-setup class=md-nav__link> <span class=md-ellipsis> Software setup </span> </a> </li> <li class=md-nav__item> <a href=#saving-your-model class=md-nav__link> <span class=md-ellipsis> Saving your model </span> </a> </li> <li class=md-nav__item> <a href=#inference-in-cmssw class=md-nav__link> <span class=md-ellipsis> Inference in CMSSW </span> </a> <nav class=md-nav aria-label="Inference in CMSSW"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cmssw-module-setup class=md-nav__link> <span class=md-ellipsis> CMSSW module setup </span> </a> </li> <li class=md-nav__item> <a href=#single-threaded-inference class=md-nav__link> <span class=md-ellipsis> Single-threaded inference </span> </a> <nav class=md-nav aria-label="Single-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes class=md-nav__link> <span class=md-ellipsis> 1. Includes </span> </a> </li> <li class=md-nav__item> <a href=#2-initialize-objects class=md-nav__link> <span class=md-ellipsis> 2. Initialize objects </span> </a> </li> <li class=md-nav__item> <a href=#3-inference class=md-nav__link> <span class=md-ellipsis> 3. Inference </span> </a> </li> <li class=md-nav__item> <a href=#4-cleanup class=md-nav__link> <span class=md-ellipsis> 4. Cleanup </span> </a> </li> <li class=md-nav__item> <a href=#full-example class=md-nav__link> <span class=md-ellipsis> Full example </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#multi-threaded-inference class=md-nav__link> <span class=md-ellipsis> Multi-threaded inference </span> </a> <nav class=md-nav aria-label="Multi-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes_1 class=md-nav__link> <span class=md-ellipsis> 1. Includes </span> </a> </li> <li class=md-nav__item> <a href=#2-define-and-use-the-global-cache class=md-nav__link> <span class=md-ellipsis> 2. Define and use the global cache </span> </a> </li> <li class=md-nav__item> <a href=#3-initialize-objects class=md-nav__link> <span class=md-ellipsis> 3. Initialize objects </span> </a> </li> <li class=md-nav__item> <a href=#4-inference class=md-nav__link> <span class=md-ellipsis> 4. Inference </span> </a> </li> <li class=md-nav__item> <a href=#full-example_1 class=md-nav__link> <span class=md-ellipsis> Full example </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#gpu-backend class=md-nav__link> <span class=md-ellipsis> GPU backend </span> </a> </li> <li class=md-nav__item> <a href=#optimization class=md-nav__link> <span class=md-ellipsis> Optimization </span> </a> <nav class=md-nav aria-label=Optimization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reusing-tensors class=md-nav__link> <span class=md-ellipsis> Reusing tensors </span> </a> </li> <li class=md-nav__item> <a href=#tensor-data-access-via-pointers class=md-nav__link> <span class=md-ellipsis> Tensor data access via pointers </span> </a> </li> <li class=md-nav__item> <a href=#inter-and-intra-operation-parallelism class=md-nav__link> <span class=md-ellipsis> Inter- and intra-operation parallelism </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#miscellaneous class=md-nav__link> <span class=md-ellipsis> Miscellaneous </span> </a> <nav class=md-nav aria-label=Miscellaneous> <ul class=md-nav__list> <li class=md-nav__item> <a href=#logging class=md-nav__link> <span class=md-ellipsis> Logging </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#links-and-further-reading class=md-nav__link> <span class=md-ellipsis> Links and further reading </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=tensorflow_aot.html class=md-nav__link> <span class=md-ellipsis> TensorFlow AOT </span> </a> </li> <li class=md-nav__item> <a href=pytorch.html class=md-nav__link> <span class=md-ellipsis> PyTorch </span> </a> </li> <li class=md-nav__item> <a href=pyg.html class=md-nav__link> <span class=md-ellipsis> PyTorch Geometric </span> </a> </li> <li class=md-nav__item> <a href=onnx.html class=md-nav__link> <span class=md-ellipsis> ONNX </span> </a> </li> <li class=md-nav__item> <a href=xgboost.html class=md-nav__link> <span class=md-ellipsis> XGBoost </span> </a> </li> <li class=md-nav__item> <a href=hls4ml.html class=md-nav__link> <span class=md-ellipsis> hls4ml </span> </a> </li> <li class=md-nav__item> <a href=conifer.html class=md-nav__link> <span class=md-ellipsis> conifer </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4_2> <label class=md-nav__link for=__nav_4_4_2 id=__nav_4_4_2_label tabindex=0> <span class=md-ellipsis> Inference as a service </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4_2> <span class="md-nav__icon md-icon"></span> Inference as a service </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=sonic_triton.html class=md-nav__link> <span class=md-ellipsis> Sonic/Triton </span> </a> </li> <li class=md-nav__item> <a href=tfaas.html class=md-nav__link> <span class=md-ellipsis> TFaaS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4_3> <label class=md-nav__link for=__nav_4_4_3 id=__nav_4_4_3_label tabindex=0> <span class=md-ellipsis> Non-standard workflows </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4_3> <span class="md-nav__icon md-icon"></span> Non-standard workflows </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=standalone.html class=md-nav__link> <span class=md-ellipsis> Standalone framework </span> </a> </li> <li class=md-nav__item> <a href=swan_aws.html class=md-nav__link> <span class=md-ellipsis> SWAN + AWS </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=checklist.html class=md-nav__link> <span class=md-ellipsis> Integration checklist </span> </a> </li> <li class=md-nav__item> <a href=performance.html class=md-nav__link> <span class=md-ellipsis> Performance </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4_6> <label class=md-nav__link for=__nav_4_4_6 id=__nav_4_4_6_label tabindex=0> <span class=md-ellipsis> Successful integrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_4_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4_6> <span class="md-nav__icon md-icon"></span> Successful integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=particlenet.html class=md-nav__link> <span class=md-ellipsis> ParticleNet </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5 id=__nav_4_5_label tabindex=0> <span class=md-ellipsis> Training </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Training </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../training/Decorrelation.html class=md-nav__link> <span class=md-ellipsis> Decorrelation </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_5_2> <label class=md-nav__link for=__nav_4_5_2 id=__nav_4_5_2_label tabindex=0> <span class=md-ellipsis> Training as a Service </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_5_2> <span class="md-nav__icon md-icon"></span> Training as a Service </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../training/MLaaS4HEP.html class=md-nav__link> <span class=md-ellipsis> MLaaS4HEP </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../training/autoencoders.html class=md-nav__link> <span class=md-ellipsis> Autoencoders </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#available-versions class=md-nav__link> <span class=md-ellipsis> Available versions </span> </a> </li> <li class=md-nav__item> <a href=#software-setup class=md-nav__link> <span class=md-ellipsis> Software setup </span> </a> </li> <li class=md-nav__item> <a href=#saving-your-model class=md-nav__link> <span class=md-ellipsis> Saving your model </span> </a> </li> <li class=md-nav__item> <a href=#inference-in-cmssw class=md-nav__link> <span class=md-ellipsis> Inference in CMSSW </span> </a> <nav class=md-nav aria-label="Inference in CMSSW"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cmssw-module-setup class=md-nav__link> <span class=md-ellipsis> CMSSW module setup </span> </a> </li> <li class=md-nav__item> <a href=#single-threaded-inference class=md-nav__link> <span class=md-ellipsis> Single-threaded inference </span> </a> <nav class=md-nav aria-label="Single-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes class=md-nav__link> <span class=md-ellipsis> 1. Includes </span> </a> </li> <li class=md-nav__item> <a href=#2-initialize-objects class=md-nav__link> <span class=md-ellipsis> 2. Initialize objects </span> </a> </li> <li class=md-nav__item> <a href=#3-inference class=md-nav__link> <span class=md-ellipsis> 3. Inference </span> </a> </li> <li class=md-nav__item> <a href=#4-cleanup class=md-nav__link> <span class=md-ellipsis> 4. Cleanup </span> </a> </li> <li class=md-nav__item> <a href=#full-example class=md-nav__link> <span class=md-ellipsis> Full example </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#multi-threaded-inference class=md-nav__link> <span class=md-ellipsis> Multi-threaded inference </span> </a> <nav class=md-nav aria-label="Multi-threaded inference"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-includes_1 class=md-nav__link> <span class=md-ellipsis> 1. Includes </span> </a> </li> <li class=md-nav__item> <a href=#2-define-and-use-the-global-cache class=md-nav__link> <span class=md-ellipsis> 2. Define and use the global cache </span> </a> </li> <li class=md-nav__item> <a href=#3-initialize-objects class=md-nav__link> <span class=md-ellipsis> 3. Initialize objects </span> </a> </li> <li class=md-nav__item> <a href=#4-inference class=md-nav__link> <span class=md-ellipsis> 4. Inference </span> </a> </li> <li class=md-nav__item> <a href=#full-example_1 class=md-nav__link> <span class=md-ellipsis> Full example </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#gpu-backend class=md-nav__link> <span class=md-ellipsis> GPU backend </span> </a> </li> <li class=md-nav__item> <a href=#optimization class=md-nav__link> <span class=md-ellipsis> Optimization </span> </a> <nav class=md-nav aria-label=Optimization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reusing-tensors class=md-nav__link> <span class=md-ellipsis> Reusing tensors </span> </a> </li> <li class=md-nav__item> <a href=#tensor-data-access-via-pointers class=md-nav__link> <span class=md-ellipsis> Tensor data access via pointers </span> </a> </li> <li class=md-nav__item> <a href=#inter-and-intra-operation-parallelism class=md-nav__link> <span class=md-ellipsis> Inter- and intra-operation parallelism </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#miscellaneous class=md-nav__link> <span class=md-ellipsis> Miscellaneous </span> </a> <nav class=md-nav aria-label=Miscellaneous> <ul class=md-nav__list> <li class=md-nav__item> <a href=#logging class=md-nav__link> <span class=md-ellipsis> Logging </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#links-and-further-reading class=md-nav__link> <span class=md-ellipsis> Links and further reading </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=direct-inference-with-tensorflow-2>Direct inference with TensorFlow 2<a class=headerlink href=#direct-inference-with-tensorflow-2 title="Permanent link">&para;</a></h1> <hr> <p>TensorFlow 2 is available since CMSSW_11_1_X (<a href=https://github.com/cms-sw/cmssw/pull/28711>cmssw#28711</a>, <a href=https://github.com/cms-sw/cmsdist/pull/5525>cmsdist#5525</a>). The integration into the software stack can be found in <a href=https://github.com/cms-sw/cmsdist/blob/latest/tensorflow.spec>cmsdist/tensorflow.spec</a> and the interface is located in <a href=https://github.com/cms-sw/cmssw/tree/master/PhysicsTools/TensorFlow>cmssw/PhysicsTools/TensorFlow</a>.</p> <h2 id=available-versions>Available versions<a class=headerlink href=#available-versions title="Permanent link">&para;</a></h2> <div class="tabbed-set tabbed-alternate" data-tabs=1:3><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><input id=__tabbed_1_2 name=__tabbed_1 type=radio><input id=__tabbed_1_3 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1>Python 3 on el8</label><label for=__tabbed_1_2>Python 3 on slc7</label><label for=__tabbed_1_3>Python 2 on slc7</label></div> <div class=tabbed-content> <div class=tabbed-block> <table> <thead> <tr> <th style="text-align: center;">TensorFlow</th> <th>el8_amd64_gcc10</th> <th>el8_amd64_gcc11</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">v2.6.0</td> <td>≥ CMSSW_12_3_4</td> <td>-</td> </tr> <tr> <td style="text-align: center;">v2.6.4</td> <td>≥ CMSSW_12_5_0</td> <td>≥ CMSSW_12_5_0</td> </tr> </tbody> </table> </div> <div class=tabbed-block> <table> <thead> <tr> <th style="text-align: center;">TensorFlow</th> <th style="text-align: left;">slc7_amd64_gcc900</th> <th>slc7_amd64_gcc10</th> <th>slc7_amd64_gcc11</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">v2.1.0</td> <td style="text-align: left;">≥ CMSSW_11_1_0</td> <td>-</td> <td>-</td> </tr> <tr> <td style="text-align: center;">v2.3.1</td> <td style="text-align: left;">≥ CMSSW_11_2_0</td> <td>-</td> <td>-</td> </tr> <tr> <td style="text-align: center;">v2.4.1</td> <td style="text-align: left;">≥ CMSSW_11_3_0</td> <td>-</td> <td>-</td> </tr> <tr> <td style="text-align: center;">v2.5.0</td> <td style="text-align: left;">≥ CMSSW_12_0_0</td> <td>≥ CMSSW_12_0_0</td> <td>-</td> </tr> <tr> <td style="text-align: center;">v2.6.0</td> <td style="text-align: left;">≥ CMSSW_12_1_0</td> <td>≥ CMSSW_12_1_0</td> <td>≥ CMSSW_12_3_0</td> </tr> <tr> <td style="text-align: center;">v2.6.4</td> <td style="text-align: left;">-</td> <td>≥ CMSSW_12_5_0</td> <td>≥ CMSSW_13_0_0</td> </tr> </tbody> </table> </div> <div class=tabbed-block> <table> <thead> <tr> <th style="text-align: center;">TensorFlow</th> <th>slc7_amd64_gcc900</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">v2.1.0</td> <td>≥ CMSSW_11_1_0</td> </tr> <tr> <td style="text-align: center;">v2.3.1</td> <td>≥ CMSSW_11_2_0</td> </tr> </tbody> </table> </div> </div> </div> <p>At this time, only CPU support is provided. While GPU support is generally possible, it is currently disabled due to some interference with production workflows but will be enabled once they are resolved.</p> <h2 id=software-setup>Software setup<a class=headerlink href=#software-setup title="Permanent link">&para;</a></h2> <p>To run the examples shown below, create a mininmal inference setup with the following snippet. <mark>Adapt</mark> the <code>SCRAM_ARCH</code> according to your operating system and desired compiler.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>SCRAM_ARCH</span><span class=o>=</span><span class=s2>&quot;el8_amd64_gcc11&quot;</span>
<span class=nb>export</span><span class=w> </span><span class=nv>CMSSW_VERSION</span><span class=o>=</span><span class=s2>&quot;CMSSW_12_6_0&quot;</span>

<span class=nb>source</span><span class=w> </span><span class=s2>&quot;/cvmfs/cms.cern.ch/cmsset_default.sh&quot;</span><span class=w> </span><span class=s2>&quot;&quot;</span>

cmsrel<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>CMSSW_VERSION</span><span class=si>}</span><span class=s2>&quot;</span>
<span class=nb>cd</span><span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>CMSSW_VERSION</span><span class=si>}</span><span class=s2>/src&quot;</span>

cmsenv
scram<span class=w> </span>b
</code></pre></div></td></tr></table></div> <p>Below, the <a href=https://github.com/cms-ml/cmsml><code>cmsml</code></a> Python package is used to convert models from TensorFlow objects (<code>tf.function</code>'s or Keras models) to protobuf graph files (<a href=https://cmsml.readthedocs.io>documentation</a>). It should be available after executing the commands above. You can check its version via</p> <div class=highlight><pre><span></span><code>python<span class=w> </span>-c<span class=w> </span><span class=s2>&quot;import cmsml; print(cmsml.__version__)&quot;</span>
</code></pre></div> <p>and compare to the <a href=https://github.com/cms-ml/cmsml/tags>released tags</a>. If you want to install a newer version from either the <a href=https://github.com/cms-ml/cmsml>master branch of the cmsml repository</a> or the <a href=https://pypi.org/project/cmsml>Python package index (PyPI)</a>, you can simply do that via pip.</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:2><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><input id=__tabbed_2_2 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1>master</label><label for=__tabbed_2_2>PyPI</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=c1># into your user directory (usually ~/.local)</span>
pip<span class=w> </span>install<span class=w> </span>--upgrade<span class=w> </span>--user<span class=w> </span>git+https://github.com/cms-ml/cmsml

<span class=c1># _or_</span>

<span class=c1># into a custom directory</span>
pip<span class=w> </span>install<span class=w> </span>--upgrade<span class=w> </span>--prefix<span class=w> </span><span class=s2>&quot;CUSTOM_DIRECTORY&quot;</span><span class=w> </span>git+https://github.com/cms-ml/cmsml
</code></pre></div> </div> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=c1># into your user directory (usually ~/.local)</span>
pip<span class=w> </span>install<span class=w> </span>--upgrade<span class=w> </span>--user<span class=w> </span>cmsml

<span class=c1># _or_</span>

<span class=c1># into a custom directory</span>
pip<span class=w> </span>install<span class=w> </span>--upgrade<span class=w> </span>--prefix<span class=w> </span><span class=s2>&quot;CUSTOM_DIRECTORY&quot;</span><span class=w> </span>cmsml
</code></pre></div> </div> </div> </div> <h2 id=saving-your-model>Saving your model<a class=headerlink href=#saving-your-model title="Permanent link">&para;</a></h2> <p>After successfully training, you should save your model in a protobuf graph file which can be read by the interface in CMSSW. Naturally, you only want to save that part of your model that is required to run the network prediction, i.e., it should <mark>not</mark> contain operations related to model training or loss functions (unless explicitely required). Also, to reduce the memory footprint and to accelerate the inference, variables should be converted to constant tensors. Both of these model transformations are provided by the <code>cmsml</code> package.</p> <p>Instructions on how to transform and save your model are shown below, depending on whether you use Keras or plain TensorFlow with <code>tf.function</code>'s.</p> <div class="tabbed-set tabbed-alternate" data-tabs=3:2><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><input id=__tabbed_3_2 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1>Keras</label><label for=__tabbed_3_2>tf.function</label></div> <div class=tabbed-content> <div class=tabbed-block> <p>The code below saves a Keras <code>Model</code> instance as a protobuf graph file using <a href=https://cmsml.readthedocs.io/en/latest/api/tensorflow.html#cmsml.tensorflow.save_graph><code>cmsml.tensorflow.save_graph</code></a>. In order for Keras to built the internal graph representation before saving, make sure to either compile the model, or pass an <code>input_shape</code> to the first layer:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<span class=kn>import</span> <span class=nn>tf.keras.layers</span> <span class=k>as</span> <span class=nn>layers</span>
<span class=kn>import</span> <span class=nn>cmsml</span>

<span class=c1># define your model</span>
<span class=n>model</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Sequential</span><span class=p>()</span>
<span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>layers</span><span class=o>.</span><span class=n>InputLayer</span><span class=p>(</span><span class=n>input_shape</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,),</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;input&quot;</span><span class=p>))</span>
<span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;tanh&quot;</span><span class=p>))</span>
<span class=n>model</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s2>&quot;softmax&quot;</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;output&quot;</span><span class=p>))</span>

<span class=c1># train it</span>
<span class=o>...</span>

<span class=c1># convert to binary (.pb extension) protobuf</span>
<span class=c1># with variables converted to constants</span>
<span class=hll><span class=n>cmsml</span><span class=o>.</span><span class=n>tensorflow</span><span class=o>.</span><span class=n>save_graph</span><span class=p>(</span><span class=s2>&quot;graph.pb&quot;</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>variables_to_constants</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span>
<span class=c1># note: save_graph was renamed to save_frozen_graph in newer versions</span>
<span class=c1>#       of cmsml and you might see a deprecation warning</span>
</code></pre></div></td></tr></table></div> <p>Following the Keras naming conventions for certain layers, the input will be named <code>"input"</code> while the output is named <code>"sequential/output/Softmax"</code>. To cross check the names, you can save the graph in text format by using the extension <code>".pb.txt"</code>.</p> </div> <div class=tabbed-block> <p>Let's consider you write your network model in a single <code>tf.function</code>.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
<span class=kn>import</span> <span class=nn>cmsml</span>

<span class=c1># define the model</span>
<span class=nd>@tf</span><span class=o>.</span><span class=n>function</span>
<span class=k>def</span> <span class=nf>model</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
    <span class=c1># lift variable initialization to the lowest context so they are</span>
    <span class=c1># not re-initialized on every call (eager calls or signature tracing)</span>
    <span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>init_scope</span><span class=p>():</span>
        <span class=n>W</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>ones</span><span class=p>([</span><span class=mi>10</span><span class=p>,</span> <span class=mi>1</span><span class=p>]))</span>
        <span class=n>b</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>Variable</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>ones</span><span class=p>([</span><span class=mi>1</span><span class=p>]))</span>

    <span class=c1># define your &quot;complex&quot; model here</span>
    <span class=n>h</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>W</span><span class=p>),</span> <span class=n>b</span><span class=p>)</span>
    <span class=n>y</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>tanh</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;y&quot;</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>y</span>
</code></pre></div></td></tr></table></div> <p>In TensorFlow terms, the <code>model</code> function is <mark>polymorphic</mark> - it accepts different types of the input tensor <code>x</code> (<code>tf.float32</code>, <code>tf.float64</code>, ...). For each type, TensorFlow will create a <mark>concrete</mark> function with an associated <code>tf.Graph</code> object. This mechanism is referred to as <mark>signature tracing</mark>. For deeper insights into <code>tf.function</code>, the concepts of signature tracing, polymorphic and concrete functions, see the guide on <a href=https://www.tensorflow.org/guide/function>Better performance with <code>tf.function</code></a>.</p> <p>To save the model as a protobuf graph file, you explicitely need to create a concrete function. However, this is fairly easy once you know the exact type and shape of all input arguments.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1># create a concrete function</span>
<span class=n>cmodel</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>get_concrete_function</span><span class=p>(</span>
    <span class=n>tf</span><span class=o>.</span><span class=n>TensorSpec</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>10</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>float32</span><span class=p>),</span>
<span class=p>)</span>

<span class=c1># convert to binary (.pb extension) protobuf</span>
<span class=hll><span class=c1># with variables converted to constants</span>
</span><span class=n>cmsml</span><span class=o>.</span><span class=n>tensorflow</span><span class=o>.</span><span class=n>save_graph</span><span class=p>(</span><span class=s2>&quot;graph.pb&quot;</span><span class=p>,</span> <span class=n>cmodel</span><span class=p>,</span> <span class=n>variables_to_constants</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

<span class=c1># note: save_graph was renamed to save_frozen_graph in newer versions</span>
<span class=c1>#       of cmsml and you might see a deprecation warning</span>
</code></pre></div></td></tr></table></div> <p>The input will be named <code>"x"</code> while the output is named <code>"y"</code>. To cross check the names, you can save the graph in text format by using the extension <code>".pb.txt"</code>.</p> <details class=hint> <summary>Different method: Frozen signatures</summary> <p>Instead of creating a polymorphic <code>tf.function</code> and extracting a concrete one in a second step, you can directly define an input signature upon definition.</p> <div class=highlight><pre><span></span><code><span class=nd>@tf</span><span class=o>.</span><span class=n>function</span><span class=p>(</span><span class=n>input_signature</span><span class=o>=</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>TensorSpec</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>10</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>float32</span><span class=p>),))</span>
<span class=k>def</span> <span class=nf>model</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
    <span class=o>...</span>
</code></pre></div> <p>This disables signature tracing since the input signature is frozen. However, you can directly pass it to <a href=https://cmsml.readthedocs.io/en/latest/api/tensorflow.html#cmsml.tensorflow.save_graph><code>cmsml.tensorflow.save_graph</code></a>.</p> </details> </div> </div> </div> <h2 id=inference-in-cmssw>Inference in CMSSW<a class=headerlink href=#inference-in-cmssw title="Permanent link">&para;</a></h2> <p>The inference can be implemented to run in a <a href=#single-threaded-inference>single thread</a>. In general, this does not mean that the module cannot be executed with multiple threads (<code class=highlight>cmsRun<span class=w> </span>--numThreads<span class=w> </span>&lt;N&gt;<span class=w> </span>&lt;CFG_FILE&gt;</code>), but rather that its performance in terms of evaluation time and especially memory consumption is likely to be suboptimal. Therefore, for modules to be integrated into CMSSW, <mark>the <a href=#multi-threaded-inference>multi-threaded implementation</a> is strongly recommended</mark>.</p> <h3 id=cmssw-module-setup>CMSSW module setup<a class=headerlink href=#cmssw-module-setup title="Permanent link">&para;</a></h3> <p>If you aim to use the TensorFlow interface in a CMSSW <mark>plugin</mark>, make sure to include</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span><span class=w> </span><span class=nt>/&gt;</span>

<span class=nt>&lt;flags</span><span class=w> </span><span class=na>EDM_PLUGIN=</span><span class=s>&quot;1&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
</code></pre></div></td></tr></table></div> <p>in your <code>plugins/BuildFile.xml</code> file. If you are using the interface inside the <code>src/</code> or <code>interface/</code> directory of your module, make sure to create a global <code>BuildFile.xml</code> file next to theses directories, containing (at least):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span><span class=w> </span><span class=nt>/&gt;</span>

<span class=nt>&lt;export&gt;</span>
<span class=w>    </span><span class=nt>&lt;lib</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;1&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=nt>&lt;/export&gt;</span>
</code></pre></div></td></tr></table></div> <h3 id=single-threaded-inference>Single-threaded inference<a class=headerlink href=#single-threaded-inference title="Permanent link">&para;</a></h3> <p>Despite <code>tf.Session</code> being removed in the Python interface as of TensorFlow 2, the concepts of</p> <ul> <li><code>Graph</code>'s, containing the <em>constant</em> computational structure and trained variables of your model,</li> <li><code>Session</code>'s, handling execution and data exchange, and</li> <li>the separation between them</li> </ul> <p>live on in the C++ interface. Thus, the overall inference approach is <strong>1)</strong> include the interface, <strong>2)</strong> initialize <code>Graph</code> and <code>session</code>, <strong>3)</strong> per event create input tensors and run the inference, and <strong>4)</strong> cleanup.</p> <h5 id=1-includes>1. Includes<a class=headerlink href=#1-includes title="Permanent link">&para;</a></h5> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/one/EDAnalyzer.h&quot;</span>
<span class=c1>// further framework includes</span>
<span class=p>...</span>
</code></pre></div></td></tr></table></div> <h5 id=2-initialize-objects>2. Initialize objects<a class=headerlink href=#2-initialize-objects title="Permanent link">&para;</a></h5> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// configure logging to show warnings (see table below)</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=s>&quot;2&quot;</span><span class=p>);</span>

<span class=c1>// load the graph definition</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>GraphDef</span><span class=o>*</span><span class=w> </span><span class=n>graphDef</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>loadGraphDef</span><span class=p>(</span><span class=s>&quot;/path/to/constantgraph.pb&quot;</span><span class=p>);</span>

<span class=c1>// create a session</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span><span class=w> </span><span class=n>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> <h5 id=3-inference>3. Inference<a class=headerlink href=#3-inference title="Permanent link">&para;</a></h5> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// create an input tensor</span>
<span class=c1>// (example: single batch of 10 values)</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=w> </span><span class=nf>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=p>});</span>


<span class=c1>// fill the tensor with your input data</span>
<span class=c1>// (example: just fill consecutive values)</span>
<span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// run the evaluation</span>
<span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span><span class=w> </span><span class=n>outputs</span><span class=p>;</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>&quot;input&quot;</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>&quot;output&quot;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

<span class=c1>// process the output tensor</span>
<span class=c1>// (example: print the 5th value of the 0th (the only) example)</span>
<span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=c1>// -&gt; float</span>
</code></pre></div></td></tr></table></div> <h5 id=4-cleanup>4. Cleanup<a class=headerlink href=#4-cleanup title="Permanent link">&para;</a></h5> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>tensorflow</span><span class=o>::</span><span class=n>closeSession</span><span class=p>(</span><span class=n>session</span><span class=p>);</span>
<span class=k>delete</span><span class=w> </span><span class=n>graphDef</span><span class=p>;</span>
</code></pre></div></td></tr></table></div> <h5 id=full-example>Full example<a class=headerlink href=#full-example title="Permanent link">&para;</a></h5> <details class=hint> <summary>Click to expand</summary> <p>The example assumes the following directory structure:</p> <div class=highlight><pre><span></span><code>MySubsystem/MyModule/
│
├── plugins/
│   ├── MyPlugin.cpp
│   └── BuildFile.xml
│
├── test/
│   └── my_plugin_cfg.py
│
└── data/
    └── graph.pb
</code></pre></div> <div class="tabbed-set tabbed-alternate" data-tabs=4:3><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><input id=__tabbed_4_2 name=__tabbed_4 type=radio><input id=__tabbed_4_3 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1>plugins/MyPlugin.cpp</label><label for=__tabbed_4_2>plugins/BuildFile.xml</label><label for=__tabbed_4_3>test/my_plugin_cfg.py</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span>
<span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span>
<span class=normal>78</span>
<span class=normal>79</span>
<span class=normal>80</span>
<span class=normal>81</span>
<span class=normal>82</span>
<span class=normal>83</span>
<span class=normal>84</span>
<span class=normal>85</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cm>/*</span>
<span class=hll><span class=cm> * Example plugin to demonstrate the direct single-threaded inference with TensorFlow 2.</span>
</span><span class=cm> */</span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;memory&gt;</span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/Event.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/Frameworkfwd.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/MakerMacros.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/one/EDAnalyzer.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/ParameterSet/interface/ParameterSet.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span>

<span class=k>class</span><span class=w> </span><span class=nc>MyPlugin</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>one</span><span class=o>::</span><span class=n>EDAnalyzer</span><span class=o>&lt;&gt;</span><span class=w> </span><span class=p>{</span>
<span class=k>public</span><span class=o>:</span>
<span class=w>  </span><span class=k>explicit</span><span class=w> </span><span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>);</span>
<span class=w>  </span><span class=o>~</span><span class=n>MyPlugin</span><span class=p>(){};</span>

<span class=w>  </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span><span class=p>);</span>

<span class=k>private</span><span class=o>:</span>
<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=n>beginJob</span><span class=p>();</span>
<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>analyze</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span><span class=p>);</span>
<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>endJob</span><span class=p>();</span>

<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>graphPath_</span><span class=p>;</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>inputTensorName_</span><span class=p>;</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>outputTensorName_</span><span class=p>;</span>

<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>GraphDef</span><span class=o>*</span><span class=w> </span><span class=n>graphDef_</span><span class=p>;</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span><span class=w> </span><span class=n>session_</span><span class=p>;</span>
<span class=p>};</span>

<span class=kt>void</span><span class=w> </span><span class=nf>MyPlugin::fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span><span class=w> </span><span class=n>descriptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// defining this function will lead to a *_cfi file being generated when compiling</span>
<span class=w>  </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSetDescription</span><span class=w> </span><span class=n>desc</span><span class=p>;</span>
<span class=w>  </span><span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=n>descriptions</span><span class=p>.</span><span class=n>addWithDefaultLabel</span><span class=p>(</span><span class=n>desc</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MyPlugin</span><span class=o>::</span><span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=w> </span><span class=n>config</span><span class=p>)</span>
<span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>graphPath_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>)),</span>
<span class=w>      </span><span class=n>inputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>)),</span>
<span class=w>      </span><span class=n>outputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>)),</span>
<span class=w>      </span><span class=n>graphDef_</span><span class=p>(</span><span class=k>nullptr</span><span class=p>),</span>
<span class=w>      </span><span class=n>session_</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// set tensorflow log level to warning</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=s>&quot;2&quot;</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>beginJob</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// load the graph</span>
<span class=w>  </span><span class=n>graphDef_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>loadGraphDef</span><span class=p>(</span><span class=n>graphPath_</span><span class=p>);</span>

<span class=w>  </span><span class=c1>// create a new session and add the graphDef</span>
<span class=w>  </span><span class=n>session_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef_</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>endJob</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// close the session</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>closeSession</span><span class=p>(</span><span class=n>session_</span><span class=p>);</span>

<span class=w>  </span><span class=c1>// delete the graph</span>
<span class=w>  </span><span class=k>delete</span><span class=w> </span><span class=n>graphDef_</span><span class=p>;</span>
<span class=w>  </span><span class=n>graphDef_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>analyze</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span><span class=w> </span><span class=n>setup</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// define a tensor and fill it with range(10)</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=w> </span><span class=nf>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>});</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>

<span class=w>  </span><span class=c1>// define the output and run</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span><span class=w> </span><span class=n>outputs</span><span class=p>;</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session_</span><span class=p>,</span><span class=w> </span><span class=p>{{</span><span class=n>inputTensorName_</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=p>}},</span><span class=w> </span><span class=p>{</span><span class=n>outputTensorName_</span><span class=p>},</span><span class=w> </span><span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

<span class=w>  </span><span class=c1>// print the output</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; -&gt; &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>DEFINE_FWK_MODULE</span><span class=p>(</span><span class=n>MyPlugin</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;FWCore/Framework&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;FWCore/PluginManager&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;FWCore/ParameterSet&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span><span class=w> </span><span class=nt>/&gt;</span>

<span class=nt>&lt;flags</span><span class=w> </span><span class=na>EDM_PLUGIN=</span><span class=s>&quot;1&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
</code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>os</span>

<span class=kn>import</span> <span class=nn>FWCore.ParameterSet.Config</span> <span class=k>as</span> <span class=nn>cms</span>
<span class=kn>from</span> <span class=nn>FWCore.ParameterSet.VarParsing</span> <span class=kn>import</span> <span class=n>VarParsing</span>


<span class=c1># get the data/ directory</span>
<span class=n>thisdir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=vm>__file__</span><span class=p>))</span>
<span class=n>datadir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>thisdir</span><span class=p>),</span> <span class=s2>&quot;data&quot;</span><span class=p>)</span>

<span class=c1># setup minimal options</span>
<span class=n>options</span> <span class=o>=</span> <span class=n>VarParsing</span><span class=p>(</span><span class=s2>&quot;python&quot;</span><span class=p>)</span>
<span class=n>options</span><span class=o>.</span><span class=n>setDefault</span><span class=p>(</span><span class=s2>&quot;inputFiles&quot;</span><span class=p>,</span> <span class=s2>&quot;root://xrootd-cms.infn.it//store/mc/RunIISummer20UL17MiniAODv2/TTToSemiLeptonic_TuneCP5_13TeV-powheg-pythia8/MINIAODSIM/106X_mc2017_realistic_v9-v1/00000/005708B7-331C-904E-88B9-189011E6C9DD.root&quot;</span><span class=p>)</span>  <span class=c1># noqa</span>
<span class=n>options</span><span class=o>.</span><span class=n>parseArguments</span><span class=p>()</span>

<span class=c1># define the process to run</span>
<span class=n>process</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=s2>&quot;TEST&quot;</span><span class=p>)</span>

<span class=c1># minimal configuration</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;FWCore.MessageService.MessageLogger_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>MessageLogger</span><span class=o>.</span><span class=n>cerr</span><span class=o>.</span><span class=n>FwkReport</span><span class=o>.</span><span class=n>reportEvery</span> <span class=o>=</span> <span class=mi>1</span>
<span class=n>process</span><span class=o>.</span><span class=n>maxEvents</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span>
    <span class=nb>input</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>int32</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span>
<span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>source</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Source</span><span class=p>(</span>
    <span class=s2>&quot;PoolSource&quot;</span><span class=p>,</span>
    <span class=n>fileNames</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>vstring</span><span class=p>(</span><span class=n>options</span><span class=o>.</span><span class=n>inputFiles</span><span class=p>),</span>
<span class=p>)</span>

<span class=c1># process options</span>
<span class=n>process</span><span class=o>.</span><span class=n>options</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span>
    <span class=n>allowUnscheduled</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
    <span class=n>wantSummary</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
<span class=p>)</span>

<span class=c1># setup MyPlugin by loading the auto-generated cfi (see MyPlugin.fillDescriptions)</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;MySubsystem.MyModule.myPlugin_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>graphPath</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>datadir</span><span class=p>,</span> <span class=s2>&quot;graph.pb&quot;</span><span class=p>))</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>inputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;input&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>outputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;output&quot;</span><span class=p>)</span>

<span class=c1># define what to run in the path</span>
<span class=n>process</span><span class=o>.</span><span class=n>p</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </div> </div> </div> </details> <h3 id=multi-threaded-inference>Multi-threaded inference<a class=headerlink href=#multi-threaded-inference title="Permanent link">&para;</a></h3> <p>Compared to the single-threaded implementation <a href=#single-threaded-inference>above</a>, the multi-threaded version has one major difference: <mark>both the <code>Graph</code> and the <code>Session</code> are no longer members of a particular module instance, but rather shared between all instances in all threads</mark>. See the documentation on the <a href=https://twiki.cern.ch/twiki/bin/view/CMSPublic/FWMultithreadedFrameworkStreamModuleInterface>C++ interface of <code>stream</code> modules</a> for details.</p> <div class="admonition danger"> <p class=admonition-title>Recommendation updated</p> <p>The previous recommendation stated that the <code>Session</code> is not constant and thus, should not be placed in the global cache, but rather created once per stream module instance. However, it was discovered that, although not explicitely declared as constant in the <code>tensorflow::run()</code> / <code>Session::run()</code> interface, the session is actually not changed during evaluation and can be treated as being effectively constant.</p> <p>As a result, it is safe to move it to the global cache, next to the <code>Graph</code> object. The TensorFlow interface in CMSSW was adjusted in order to accept <code>const</code> objects in <a href=https://github.com/cms-sw/cmssw/pull/40161>cmssw#40161</a>.</p> </div> <p>Thus, the overall inference approach is <strong>1)</strong> include the interface, <strong>2)</strong> let your plugin inherit from <code class=highlight><span class=n>edm</span><span class=o>::</span><span class=n>stream</span><span class=o>::</span><span class=n>EDAnalyzerasdasd</span></code> and declare the <code>GlobalCache</code>, <strong>3)</strong> store in c<code class=highlight><span class=k>const</span><span class=w> </span><span class=n>Session</span><span class=o>*</span></code>, pointing to the cached session, and <strong>4)</strong> per event create input tensors and run the inference.</p> <h5 id=1-includes_1>1. Includes<a class=headerlink href=#1-includes_1 title="Permanent link">&para;</a></h5> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span>
<span class=hll><span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/stream/EDAnalyzer.h&quot;</span>
</span><span class=c1>// further framework includes</span>
<span class=p>...</span>
</code></pre></div></td></tr></table></div> <p>Note that <code>stream/EDAnalyzer.h</code> is included rather than <code>one/EDAnalyzer.h</code>.</p> <h5 id=2-define-and-use-the-global-cache>2. Define and use the global cache<a class=headerlink href=#2-define-and-use-the-global-cache title="Permanent link">&para;</a></h5> <p>The cache definition is done by declaring a simple struct. However, for the purpose of just storing a graph and a session object, a so-called <a href=https://github.com/cms-sw/cmssw/blob/cf78146456e111d5943da222cfac22e57f3c0355/PhysicsTools/TensorFlow/interface/TensorFlow.h#L184-L215><code>tensorflow::SessionCache</code></a> struct is already provided centrally. It was added in <a href=https://github.com/cms-sw/cmssw/pull/40284>cmssw#40284</a> and its usage is shown in the following. In case the <code>tensorflow::SessionCache</code> is not (yet) available in your version of CMSSW, expand the "Custom cache struct" section below.</p> <p>Use it in the <code class=highlight><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span></code> template argument and adjust the plugin accordingly.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>class</span><span class=w> </span><span class=nc>MyPlugin</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>stream</span><span class=o>::</span><span class=n>EDAnalyzer</span><span class=o>&lt;</span><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span>
<span class=k>public</span><span class=o>:</span>
<span class=w>    </span><span class=k>explicit</span><span class=w> </span><span class=n>GraphLoadingMT</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=p>);</span>
<span class=w>    </span><span class=o>~</span><span class=n>GraphLoadingMT</span><span class=p>();</span>

<span class=w>    </span><span class=c1>// additional static methods for initializing and closing the global cache</span>
<span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;</span><span class=w> </span><span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>);</span>
<span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>globalEndJob</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=p>);</span>
<span class=p>...</span>
</code></pre></div></td></tr></table></div> <p>Implement <code>initializeGlobalCache</code> to control the behavior of how the cache object is created. You also need to implement <code>globalEndJob</code>, however, it can remain empty as the destructor of <code>tensorflow::SessionCache</code> already handles the closing of the session itself and the deletion of all objects.</p> <div class=highlight><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=w> </span><span class=n>config</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>graphPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>FileInPath</span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>)).</span><span class=n>fullPath</span><span class=p>();</span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;</span><span class=p>(</span><span class=n>graphPath</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>globalEndJob</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=w> </span><span class=n>cache</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
</code></pre></div> <details class=hint> <summary>Custom cache struct</summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>struct</span><span class=w> </span><span class=nc>MyCache</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>MyCache</span><span class=p>()</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=p>}</span>

<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>GraphDef</span><span class=o>*&gt;</span><span class=w> </span><span class=n>graph</span><span class=p>;</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>atomic</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*&gt;</span><span class=w> </span><span class=n>session</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div></td></tr></table></div> <p>Use it in the <code class=highlight><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span></code> template argument and adjust the plugin accordingly.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span>
<span class=normal>9</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>class</span><span class=w> </span><span class=nc>MyPlugin</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>stream</span><span class=o>::</span><span class=n>EDAnalyzer</span><span class=o>&lt;</span><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span>
<span class=k>public</span><span class=o>:</span>
<span class=w>    </span><span class=k>explicit</span><span class=w> </span><span class=n>GraphLoadingMT</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>CacheData</span><span class=o>*</span><span class=p>);</span>
<span class=w>    </span><span class=o>~</span><span class=n>GraphLoadingMT</span><span class=p>();</span>

<span class=w>    </span><span class=c1>// two additional static methods for handling the global cache</span>
<span class=w>    </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>CacheData</span><span class=o>&gt;</span><span class=w> </span><span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>);</span>
<span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>globalEndJob</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>CacheData</span><span class=o>*</span><span class=p>);</span>
<span class=p>...</span>
</code></pre></div></td></tr></table></div> <p>Implement <code>initializeGlobalCache</code> and <code>globalEndJob</code> to control the behavior of how the cache object is created and destroyed.</p> </details> <p>See the <a href=#full-example_1>full example</a> below for more details.</p> <h5 id=3-initialize-objects>3. Initialize objects<a class=headerlink href=#3-initialize-objects title="Permanent link">&para;</a></h5> <p>In your module constructor, you can get a pointer to the constant session to perform model evaluation during the event loop.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// declaration in header</span>
<span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span><span class=w> </span><span class=n>_session</span><span class=p>;</span>

<span class=c1>// get a pointer to the const session stored in the cache in the constructor init</span>
<span class=n>MyPlugin</span><span class=o>::</span><span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w>  </span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=w> </span><span class=n>cache</span><span class=p>)</span>
<span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>session_</span><span class=p>(</span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>getSession</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=p>...</span>
<span class=p>}</span>
</code></pre></div></td></tr></table></div> <h5 id=4-inference>4. Inference<a class=headerlink href=#4-inference title="Permanent link">&para;</a></h5> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1>// create an input tensor</span>
<span class=c1>// (example: single batch of 10 values)</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=w> </span><span class=nf>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=p>});</span>


<span class=c1>// fill the tensor with your input data</span>
<span class=c1>// (example: just fill consecutive values)</span>
<span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// define the output</span>
<span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span><span class=w> </span><span class=n>outputs</span><span class=p>;</span>

<span class=c1>// evaluate</span>
<span class=c1>// note: in case this line causes the compiler to complain about the const&#39;ness of the session_ in</span>
<span class=c1>//       this call, your CMSSW version might not yet support passing a const session, so in this</span>
<span class=c1>//       case, pass &quot;const_cast&lt;tensorflow::Session*&gt;(session_)&quot;</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session_</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>inputTensorName</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>outputTensorName</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

<span class=c1>// process the output tensor</span>
<span class=c1>// (example: print the 5th value of the 0th (the only) example)</span>
<span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=c1>// -&gt; float</span>
</code></pre></div></td></tr></table></div> <div class="admonition danger"> <p class=admonition-title>Note</p> <p>If the TensorFlow interface in your CMSSW release does not yet accept <code class=highlight><span class=k>const</span></code> sessions, line 19 in the example above will cause an error during compilation. In this case, replace <code class=highlight><span class=n>session_</span></code> in that line to</p> <div class=highlight><pre><span></span><code><span class=k>const_cast</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>session_</span><span class=p>)</span>
</code></pre></div> </div> <h5 id=full-example_1>Full example<a class=headerlink href=#full-example_1 title="Permanent link">&para;</a></h5> <details class=hint> <summary>Click to expand</summary> <p>The example assumes the following directory structure:</p> <div class=highlight><pre><span></span><code>MySubsystem/MyModule/
│
├── plugins/
│   ├── MyPlugin.cpp
│   └── BuildFile.xml
│
├── test/
│   └── my_plugin_cfg.py
│
└── data/
    └── graph.pb
</code></pre></div> <div class="tabbed-set tabbed-alternate" data-tabs=5:3><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><input id=__tabbed_5_2 name=__tabbed_5 type=radio><input id=__tabbed_5_3 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1>plugins/MyPlugin.cpp</label><label for=__tabbed_5_2>plugins/BuildFile.xml</label><label for=__tabbed_5_3>test/my_plugin_cfg.py</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span>
<span class=normal>73</span>
<span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span>
<span class=normal>78</span>
<span class=normal>79</span>
<span class=normal>80</span>
<span class=normal>81</span>
<span class=normal>82</span>
<span class=normal>83</span>
<span class=normal>84</span>
<span class=normal>85</span>
<span class=normal>86</span>
<span class=normal>87</span>
<span class=normal>88</span>
<span class=normal>89</span>
<span class=normal>90</span>
<span class=normal>91</span>
<span class=normal>92</span>
<span class=normal>93</span>
<span class=normal>94</span></pre></div></td><td class=code><div><pre><span></span><code><span class=cm>/*</span>
<span class=hll><span class=cm> * Example plugin to demonstrate the direct multi-threaded inference with TensorFlow 2.</span>
</span><span class=cm> */</span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;memory&gt;</span>

<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/Event.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/Frameworkfwd.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/MakerMacros.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/Framework/interface/stream/EDAnalyzer.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;FWCore/ParameterSet/interface/ParameterSet.h&quot;</span>
<span class=cp>#include</span><span class=w> </span><span class=cpf>&quot;PhysicsTools/TensorFlow/interface/TensorFlow.h&quot;</span>

<span class=c1>// put a tensorflow::SessionCache into the global cache structure</span>
<span class=c1>// the session cache wraps both a tf graph and a tf session instance and also handles their deletion</span>
<span class=k>class</span><span class=w> </span><span class=nc>MyPlugin</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>stream</span><span class=o>::</span><span class=n>EDAnalyzer</span><span class=o>&lt;</span><span class=n>edm</span><span class=o>::</span><span class=n>GlobalCache</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span>
<span class=k>public</span><span class=o>:</span>
<span class=w>  </span><span class=k>explicit</span><span class=w> </span><span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=p>);</span>
<span class=w>  </span><span class=o>~</span><span class=n>MyPlugin</span><span class=p>(){};</span>

<span class=w>  </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span><span class=p>);</span>

<span class=w>  </span><span class=c1>// additional static methods for initializing and closing the global cache</span>
<span class=w>  </span><span class=k>static</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;</span><span class=w> </span><span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=p>);</span>
<span class=w>  </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>globalEndJob</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=p>);</span>

<span class=k>private</span><span class=o>:</span>
<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=n>beginJob</span><span class=p>();</span>
<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>analyze</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span><span class=p>);</span>
<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>endJob</span><span class=p>();</span>

<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>inputTensorName_</span><span class=p>;</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>outputTensorName_</span><span class=p>;</span>

<span class=w>  </span><span class=c1>// a pointer to the session created by the global session cache</span>
<span class=w>  </span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span><span class=w> </span><span class=n>session_</span><span class=p>;</span>
<span class=p>};</span>

<span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>initializeGlobalCache</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// this method is supposed to create, initialize and return a SessionCache instance</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>graphPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>FileInPath</span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>)).</span><span class=n>fullPath</span><span class=p>();</span>
<span class=w>  </span><span class=c1>// Setup the TF backend by configuration</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>params</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;tf_backend&quot;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&quot;cuda&quot;</span><span class=p>){</span>
<span class=w>    </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Backend</span><span class=o>::</span><span class=n>cuda</span><span class=p>};</span>
<span class=w>  </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Backend</span><span class=o>::</span><span class=n>cpu</span><span class=p>};</span>
<span class=w>  </span><span class=p>}</span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_unique</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>&gt;</span><span class=p>(</span><span class=n>graphPath</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>globalEndJob</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=w> </span><span class=n>cache</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>fillDescriptions</span><span class=p>(</span><span class=n>edm</span><span class=o>::</span><span class=n>ConfigurationDescriptions</span><span class=o>&amp;</span><span class=w> </span><span class=n>descriptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// defining this function will lead to a *_cfi file being generated when compiling</span>
<span class=w>  </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSetDescription</span><span class=w> </span><span class=n>desc</span><span class=p>;</span>
<span class=w>  </span><span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;graphPath&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=n>desc</span><span class=p>.</span><span class=n>add</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>);</span>
<span class=w>  </span><span class=n>descriptions</span><span class=p>.</span><span class=n>addWithDefaultLabel</span><span class=p>(</span><span class=n>desc</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MyPlugin</span><span class=o>::</span><span class=n>MyPlugin</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>ParameterSet</span><span class=o>&amp;</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w>  </span><span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=o>*</span><span class=w> </span><span class=n>cache</span><span class=p>)</span>
<span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>inputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;inputTensorName&quot;</span><span class=p>)),</span>
<span class=w>      </span><span class=n>outputTensorName_</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>getParameter</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&quot;outputTensorName&quot;</span><span class=p>)),</span>
<span class=w>      </span><span class=n>session_</span><span class=p>(</span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>getSession</span><span class=p>())</span><span class=w> </span><span class=p>{}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>beginJob</span><span class=p>()</span><span class=w> </span><span class=p>{}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>endJob</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// close the session</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>closeSession</span><span class=p>(</span><span class=n>session_</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span><span class=w> </span><span class=n>MyPlugin</span><span class=o>::</span><span class=n>analyze</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>Event</span><span class=o>&amp;</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>edm</span><span class=o>::</span><span class=n>EventSetup</span><span class=o>&amp;</span><span class=w> </span><span class=n>setup</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=c1>// define a tensor and fill it with range(10)</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=w> </span><span class=nf>input</span><span class=p>(</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>DT_FLOAT</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>});</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>input</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>

<span class=w>  </span><span class=c1>// define the output</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span><span class=w> </span><span class=n>outputs</span><span class=p>;</span>

<span class=w>  </span><span class=c1>// evaluate</span>
<span class=w>  </span><span class=c1>// note: in case this line causes the compile to complain about the const&#39;ness of the session_ in</span>
<span class=w>  </span><span class=c1>//       this call, your CMSSW version might not yet support passing a const session, so in this</span>
<span class=w>  </span><span class=c1>//       case, pass &quot;const_cast&lt;tensorflow::Session*&gt;(session_)&quot;</span>
<span class=w>  </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=n>session_</span><span class=p>,</span><span class=w> </span><span class=p>{{</span><span class=n>inputTensorName_</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=p>}},</span><span class=w> </span><span class=p>{</span><span class=n>outputTensorName_</span><span class=p>},</span><span class=w> </span><span class=o>&amp;</span><span class=n>outputs</span><span class=p>);</span>

<span class=w>  </span><span class=c1>// print the output</span>
<span class=w>  </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; -&gt; &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>outputs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>DEFINE_FWK_MODULE</span><span class=p>(</span><span class=n>MyPlugin</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;FWCore/Framework&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;FWCore/PluginManager&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;FWCore/ParameterSet&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
<span class=nt>&lt;use</span><span class=w> </span><span class=na>name=</span><span class=s>&quot;PhysicsTools/TensorFlow&quot;</span><span class=w> </span><span class=nt>/&gt;</span>

<span class=nt>&lt;flags</span><span class=w> </span><span class=na>EDM_PLUGIN=</span><span class=s>&quot;1&quot;</span><span class=w> </span><span class=nt>/&gt;</span>
</code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 1</span>
<span class=normal> 2</span>
<span class=normal> 3</span>
<span class=normal> 4</span>
<span class=normal> 5</span>
<span class=normal> 6</span>
<span class=normal> 7</span>
<span class=normal> 8</span>
<span class=normal> 9</span>
<span class=normal>10</span>
<span class=normal>11</span>
<span class=normal>12</span>
<span class=normal>13</span>
<span class=normal>14</span>
<span class=normal>15</span>
<span class=normal>16</span>
<span class=normal>17</span>
<span class=normal>18</span>
<span class=normal>19</span>
<span class=normal>20</span>
<span class=normal>21</span>
<span class=normal>22</span>
<span class=normal>23</span>
<span class=normal>24</span>
<span class=normal>25</span>
<span class=normal>26</span>
<span class=normal>27</span>
<span class=normal>28</span>
<span class=normal>29</span>
<span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span></pre></div></td><td class=code><div><pre><span></span><code><span class=c1># coding: utf-8</span>

<span class=kn>import</span> <span class=nn>os</span>

<span class=kn>import</span> <span class=nn>FWCore.ParameterSet.Config</span> <span class=k>as</span> <span class=nn>cms</span>
<span class=kn>from</span> <span class=nn>FWCore.ParameterSet.VarParsing</span> <span class=kn>import</span> <span class=n>VarParsing</span>


<span class=c1># get the data/ directory</span>
<span class=n>thisdir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span><span class=vm>__file__</span><span class=p>))</span>
<span class=n>datadir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>thisdir</span><span class=p>),</span> <span class=s2>&quot;data&quot;</span><span class=p>)</span>

<span class=c1># setup minimal options</span>
<span class=n>options</span> <span class=o>=</span> <span class=n>VarParsing</span><span class=p>(</span><span class=s2>&quot;python&quot;</span><span class=p>)</span>
<span class=n>options</span><span class=o>.</span><span class=n>setDefault</span><span class=p>(</span><span class=s2>&quot;inputFiles&quot;</span><span class=p>,</span> <span class=s2>&quot;root://xrootd-cms.infn.it//store/mc/RunIISummer20UL17MiniAODv2/TTToSemiLeptonic_TuneCP5_13TeV-powheg-pythia8/MINIAODSIM/106X_mc2017_realistic_v9-v1/00000/005708B7-331C-904E-88B9-189011E6C9DD.root&quot;</span><span class=p>)</span>  <span class=c1># noqa</span>
<span class=n>options</span><span class=o>.</span><span class=n>parseArguments</span><span class=p>()</span>

<span class=c1># define the process to run</span>
<span class=n>process</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=s2>&quot;TEST&quot;</span><span class=p>)</span>

<span class=c1># minimal configuration</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;FWCore.MessageService.MessageLogger_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>MessageLogger</span><span class=o>.</span><span class=n>cerr</span><span class=o>.</span><span class=n>FwkReport</span><span class=o>.</span><span class=n>reportEvery</span> <span class=o>=</span> <span class=mi>1</span>
<span class=n>process</span><span class=o>.</span><span class=n>maxEvents</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span>
    <span class=nb>input</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>int32</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span>
<span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>source</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Source</span><span class=p>(</span>
    <span class=s2>&quot;PoolSource&quot;</span><span class=p>,</span>
    <span class=n>fileNames</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>vstring</span><span class=p>(</span><span class=n>options</span><span class=o>.</span><span class=n>inputFiles</span><span class=p>),</span>
<span class=p>)</span>

<span class=c1># process options</span>
<span class=n>process</span><span class=o>.</span><span class=n>options</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>PSet</span><span class=p>(</span>
    <span class=n>allowUnscheduled</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
    <span class=n>wantSummary</span><span class=o>=</span><span class=n>cms</span><span class=o>.</span><span class=n>untracked</span><span class=o>.</span><span class=n>bool</span><span class=p>(</span><span class=kc>True</span><span class=p>),</span>
<span class=p>)</span>

<span class=c1># setup MyPlugin by loading the auto-generated cfi (see MyPlugin.fillDescriptions)</span>
<span class=n>process</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;MySubsystem.MyModule.myPlugin_cfi&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>graphPath</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>datadir</span><span class=p>,</span> <span class=s2>&quot;graph.pb&quot;</span><span class=p>))</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>inputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;input&quot;</span><span class=p>)</span>
<span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=o>.</span><span class=n>outputTensorName</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s2>&quot;output&quot;</span><span class=p>)</span>

<span class=c1># define what to run in the path</span>
<span class=n>process</span><span class=o>.</span><span class=n>p</span> <span class=o>=</span> <span class=n>cms</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=n>process</span><span class=o>.</span><span class=n>myPlugin</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </div> </div> </div> </details> <h3 id=gpu-backend>GPU backend<a class=headerlink href=#gpu-backend title="Permanent link">&para;</a></h3> <p>By default the TensorFlow sessions get created for CPU running. Since CMSSW_13_1_X the GPU backend for TensorFlow is available in the cmssw release. </p> <p>Minimal changes are needed in the inference code to move the model on the GPU. A <code>tensorflow::Options</code> struct is available to setup the backend. </p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>tensorflow</span><span class=o>::</span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Backend</span><span class=o>::</span><span class=n>cuda</span><span class=p>};</span>

<span class=cp># Initialize the cache</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionCache</span><span class=w> </span><span class=nf>cache</span><span class=p>(</span><span class=n>pbFile</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
<span class=cp># or a single session</span>
<span class=k>const</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span><span class=w> </span><span class=n>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> <p>CMSSW modules should add an options in the <code>PSets</code> of the producers and analyzers to configure on the fly the TensorFlow backend for the sessions created by the plugins. </p> <h3 id=optimization>Optimization<a class=headerlink href=#optimization title="Permanent link">&para;</a></h3> <p>Depending on the use case, the following approaches can optimize the inference performance. It could be worth checking them out in your algorithm.</p> <p>Further optimization approaches can be found in the <a href=checklist.html>integration checklist</a>.</p> <h4 id=reusing-tensors>Reusing tensors<a class=headerlink href=#reusing-tensors title="Permanent link">&para;</a></h4> <p>In some cases, instead of creating new input tensors for each inference call, you might want to store input tensors as members of your plugin. This is of course possible if you know its exact shape a-prioro and comes with the cost of keeping the tensor in memory for the lifetime of your module instance.</p> <p>You can use</p> <div class=highlight><pre><span></span><code><span class=n>tensor</span><span class=p>.</span><span class=n>flat</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>().</span><span class=n>setZero</span><span class=p>();</span>
</code></pre></div> <p>to reset the values of your tensor prior to each call.</p> <h4 id=tensor-data-access-via-pointers>Tensor data access via pointers<a class=headerlink href=#tensor-data-access-via-pointers title="Permanent link">&para;</a></h4> <p>As shown in the examples above, tensor data can be accessed through methods such as <code>flat&lt;type&gt;()</code> or <code>matrix&lt;type&gt;()</code> which return objects that represent the underlying data in the requested structure (<a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/tensor><code>tensorflow::Tensor</code> C++ API</a>). To read and manipulate particular elements, you can directly call this object with the coordinates of an element.</p> <div class=highlight><pre><span></span><code><span class=c1>// matrix returns a 2D representation</span>
<span class=c1>// set element (b,i) to f</span>
<span class=n>tensor</span><span class=p>.</span><span class=n>matrix</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>()(</span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>float</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</code></pre></div> <p>However, doing this for a large input tensor might entail some overhead. Since the data is actually contiguous in memory (C-style "row-major" memory ordering), a faster (though less explicit) way of interacting with tensor data is using a pointer.</p> <div class=highlight><pre><span></span><code><span class=c1>// get the pointer to the first tensor element</span>
<span class=kt>float</span><span class=o>*</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensor</span><span class=p>.</span><span class=n>flat</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span><span class=p>().</span><span class=n>data</span><span class=p>();</span>
</code></pre></div> <p>Now, the tensor data can be filled using simple and fast pointer arithmetic.</p> <div class=highlight><pre><span></span><code><span class=c1>// fill tensor data using pointer arithmethic</span>
<span class=c1>// memory ordering is row-major, so the most outer loop corresponds dimension 0</span>
<span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>batchSize</span><span class=p>;</span><span class=w> </span><span class=n>b</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>nFeatures</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=c1>// note the d++</span>
<span class=hll><span class=w>        </span><span class=o>*</span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>float</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span class=w>    </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <h4 id=inter-and-intra-operation-parallelism>Inter- and intra-operation parallelism<a class=headerlink href=#inter-and-intra-operation-parallelism title="Permanent link">&para;</a></h4> <div class="admonition danger"> <p class=admonition-title>Debugging and local processing only</p> <p>Parallelism between (inter) and within (intra) operations can greatly improve the inference performance. However, this allows TensorFlow to manage and schedule threads on its own, possibly interfering with the thread model inherent to CMSSW. For inference code that is to be officially integrated, you should <mark>avoid</mark> inter- and intra-op parallelism and rather adhere to the examples shown above.</p> </div> <p>You can configure the amount of inter- and infra-op threads via the second argument of the <code class=highlight><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span></code> method.</p> <div class="tabbed-set tabbed-alternate" data-tabs=6:2><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><input id=__tabbed_6_2 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1>Simple</label><label for=__tabbed_6_2>Verbose</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span><span class=w> </span><span class=n>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef</span><span class=p>,</span><span class=w> </span><span class=n>nThreads</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> </div> <div class=tabbed-block> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>tensorflow</span><span class=o>::</span><span class=n>SessionOptions</span><span class=w> </span><span class=n>sessionOptions</span><span class=p>;</span>
<span class=n>sessionOptions</span><span class=p>.</span><span class=n>config</span><span class=p>.</span><span class=n>set_intra_op_parallelism_threads</span><span class=p>(</span><span class=n>nThreads</span><span class=p>);</span>
<span class=n>sessionOptions</span><span class=p>.</span><span class=n>config</span><span class=p>.</span><span class=n>set_inter_op_parallelism_threads</span><span class=p>(</span><span class=n>nThreads</span><span class=p>);</span>

<span class=n>tensorflow</span><span class=o>::</span><span class=n>Session</span><span class=o>*</span><span class=w> </span><span class=n>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tensorflow</span><span class=o>::</span><span class=n>createSession</span><span class=p>(</span><span class=n>graphDef</span><span class=p>,</span><span class=w> </span><span class=n>sessionOptions</span><span class=p>);</span>
</code></pre></div></td></tr></table></div> </div> </div> </div> <p>Then, when calling <code class=highlight><span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span></code>, pass the internal name of the TensorFlow threadpool, i.e. <code>"tensorflow"</code>, as the last argument.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1</span>
<span class=normal>2</span>
<span class=normal>3</span>
<span class=normal>4</span>
<span class=normal>5</span>
<span class=normal>6</span>
<span class=normal>7</span>
<span class=normal>8</span></pre></div></td><td class=code><div><pre><span></span><code><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>tensorflow</span><span class=o>::</span><span class=n>Tensor</span><span class=o>&gt;</span><span class=w> </span><span class=n>outputs</span><span class=p>;</span>
<span class=n>tensorflow</span><span class=o>::</span><span class=n>run</span><span class=p>(</span>
<span class=w>    </span><span class=n>session</span><span class=p>,</span>
<span class=w>    </span><span class=p>{</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>inputTensorName</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span>
<span class=w>    </span><span class=p>{</span><span class=w> </span><span class=n>outputTensorName</span><span class=w> </span><span class=p>},</span>
<span class=w>    </span><span class=o>&amp;</span><span class=n>outputs</span><span class=p>,</span>
<span class=w>    </span><span class=s>&quot;tensorflow&quot;</span>
<span class=p>);</span>
</code></pre></div></td></tr></table></div> <h2 id=miscellaneous>Miscellaneous<a class=headerlink href=#miscellaneous title="Permanent link">&para;</a></h2> <h3 id=logging>Logging<a class=headerlink href=#logging title="Permanent link">&para;</a></h3> <p>By default, TensorFlow logging is quite verbose. This can be changed by either setting the <code>TF_CPP_MIN_LOG_LEVEL</code> environment varibale before calling <code>cmsRun</code>, or within your code through <code class=highlight><span class=n>tensorflow</span><span class=o>::</span><span class=n>setLogging</span><span class=p>(</span><span class=n>level</span><span class=p>)</span></code>.</p> <table> <thead> <tr> <th>Verbosity level</th> <th><code>TF_CPP_MIN_LOG_LEVEL</code></th> </tr> </thead> <tbody> <tr> <td>debug</td> <td>"0"</td> </tr> <tr> <td>info</td> <td>"1" (default)</td> </tr> <tr> <td>warning</td> <td>"2"</td> </tr> <tr> <td>error</td> <td>"3"</td> </tr> <tr> <td>none</td> <td>"4"</td> </tr> </tbody> </table> <p>Forwarding logs to the <code>MessageLogger</code> service is not possible yet.</p> <h2 id=links-and-further-reading>Links and further reading<a class=headerlink href=#links-and-further-reading title="Permanent link">&para;</a></h2> <ul> <li><a href=https://cmsml.readthedocs.io><code>cmsml</code> package</a></li> <li>CMSSW<ul> <li><a href=http://cmsdoxygen.web.cern.ch/cmsdoxygen/CMSSW_11_1_2/doc/html/de/d86/namespacetensorflow.html>TensorFlow interface documentation</a></li> <li><a href=https://github.com/cms-sw/cmssw/blob/master/PhysicsTools/TensorFlow/interface/TensorFlow.h>TensorFlow interface header</a></li> <li><a href=https://twiki.cern.ch/twiki/bin/view/CMSPublic/SWGuideEDMParametersForModules#The_options_Parameter_Set>CMSSW process options</a></li> <li><a href=https://twiki.cern.ch/twiki/bin/view/CMSPublic/FWMultithreadedFrameworkStreamModuleInterface>C++ interface of <code>stream</code> modules</a></li> </ul> </li> <li>TensorFlow<ul> <li><a href=https://indico.cern.ch/event/882992/contributions/3721506/attachments/1994721/3327402/TensorFlow_2_Workshop_CERN_2020.pdf>TensorFlow 2 tutorial</a></li> <li><a href=https://www.tensorflow.org/guide/function><code>tf.function</code></a></li> <li><a href=https://www.tensorflow.org/api_docs/cc>C++ API</a></li> <li><a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/tensor><code>tensorflow::Tensor</code></a></li> <li><a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/operation><code>tensorflow::Operation</code></a></li> <li><a href=https://www.tensorflow.org/api_docs/cc/class/tensorflow/client-session><code>tensorflow::ClientSession</code></a></li> </ul> </li> <li>Keras<ul> <li><a href=https://keras.io/api>API</a></li> </ul> </li> </ul> <hr> <p>Authors: <a href=mailto:marcel.rieger@cern.ch>Marcel Rieger</a></p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 17, 2024</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2020-2023 CMS Machine Learning Group </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/cms-ml target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> <a href=https://hub.docker.com/orgs/cmsml/repositories target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg> </a> <a href=https://cms-talk.web.cern.ch/c/physics/ml/104 target=_blank rel=noopener title=cms-talk.web.cern.ch class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M256 448c141.4 0 256-93.1 256-208S397.4 32 256 32 0 125.1 0 240c0 45.1 17.7 86.8 47.7 120.9-1.9 24.5-11.4 46.3-21.4 62.9-5.5 9.2-11.1 16.6-15.2 21.6-2.1 2.5-3.7 4.4-4.9 5.7-.6.6-1 1.1-1.3 1.4l-.3.3c-4.6 4.6-5.9 11.4-3.4 17.4 2.5 6 8.3 9.9 14.8 9.9 28.7 0 57.6-8.9 81.6-19.3 22.9-10 42.4-21.9 54.3-30.6 31.8 11.5 67 17.9 104.1 17.9zM128 208a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm128 0a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm96 32a32 32 0 1 1 64 0 32 32 0 1 1-64 0z"/></svg> </a> <a href=mailto:cms-conveners-ml-knowledge@cern.ch target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48H48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0L0 176z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["instant", "navigation.sections"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.ebd0bdb7.min.js></script> <script src=https://unpkg.com/mermaid@10.9/dist/mermaid.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=../termynal.js></script> </body> </html>